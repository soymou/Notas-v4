import * as idb from 'idb';
/** @internal */
export const globalFontPromises = [];
async function addPartialFonts({ builder, hooks }) {
    const t = performance.now();
    if ('queryLocalFonts' in window) {
        const fonts = await window.queryLocalFonts();
        console.log('local fonts count:', fonts.length);
        const db = await idb.openDB('typst-ts-store', 1, {
            upgrade(db) {
                db.createObjectStore('font-information', {
                    keyPath: 'postscriptName',
                });
            },
        });
        const information = await Promise.all(fonts.map(async (font) => {
            const postscriptName = font.postscriptName;
            return (await db.get('font-information', postscriptName))?.info;
        }));
        const get_font_info = builder.handler_for_font_info();
        await builder.add_web_fonts(fonts.map((font, font_idx) => {
            let gettingBuffer = false;
            let readyBuffer = undefined;
            const fullName = font.fullName;
            const postscriptName = font.postscriptName;
            const prev = information[font_idx];
            if (prev) {
                console.log('prev', postscriptName, prev);
            }
            return {
                family: font.family,
                style: font.style,
                fullName: fullName,
                postscriptName: postscriptName,
                ref: font,
                info: information[font_idx],
                blob: (idx) => {
                    console.log(this, font, idx);
                    if (readyBuffer) {
                        return readyBuffer;
                    }
                    if (gettingBuffer) {
                        return;
                    }
                    gettingBuffer = true;
                    globalFontPromises.push((async () => {
                        const blob = await font.blob();
                        const buffer = await blob.arrayBuffer();
                        readyBuffer = buffer;
                        const realFontInfo = get_font_info(new Uint8Array(buffer));
                        console.log(realFontInfo);
                        db.put('font-information', {
                            fullName,
                            postscriptName,
                            info: realFontInfo,
                        });
                        return { buffer, idx };
                    })());
                },
            };
        }));
    }
    const t2 = performance.now();
    console.log('addPartialFonts time used:', t2 - t);
}
class ComponentBuilder {
    loadedFonts = new Set();
    fetcher = fetch;
    setFetcher(fetcher) {
        this.fetcher = fetcher;
    }
    async loadFonts(builder, fonts) {
        const escapeImport = new Function('m', 'return import(m)');
        const fetcher = (this.fetcher ||= await (async function () {
            const { fetchBuilder, FileSystemCache } = await escapeImport('node-fetch-cache');
            const cache = new FileSystemCache({
                /// By default, we don't have a complicated cache policy.
                cacheDirectory: '.cache/typst/fonts',
            });
            const cachedFetcher = fetchBuilder.withCache(cache);
            return function (input, init) {
                const timeout = setTimeout(() => {
                    console.warn('font fetching is stucking:', input);
                }, 15000);
                return cachedFetcher(input, init).finally(() => {
                    clearTimeout(timeout);
                });
            };
        })());
        const fontsToLoad = fonts.filter(font => {
            if (font instanceof Uint8Array) {
                return true;
            }
            if (this.loadedFonts.has(font)) {
                return false;
            }
            this.loadedFonts.add(font);
            return true;
        });
        const fontLists = await Promise.all(fontsToLoad.map(async (font) => {
            if (font instanceof Uint8Array) {
                await builder.add_raw_font(font);
                return;
            }
            return new Uint8Array(await (await fetcher(font)).arrayBuffer());
        }));
        for (const font of fontLists) {
            if (!font) {
                continue;
            }
            await builder.add_raw_font(font);
        }
    }
    async build(options, builder, hooks) {
        /// build typst component
        const buildCtx = { ref: this, builder, hooks };
        for (const fn of options?.beforeBuild ?? []) {
            await fn(undefined, buildCtx);
        }
        // await addPartialFonts(buildCtx);
        if (hooks.latelyBuild) {
            hooks.latelyBuild(buildCtx);
        }
        const component = await builder.build();
        return component;
    }
}
/** @internal */
export async function buildComponent(options, gModule, Builder, hooks) {
    /// init typst wasm module
    await gModule.init(options?.getModule?.());
    return await new ComponentBuilder().build(options, new Builder(), hooks);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5pdC5tanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvaW5pdC5tdHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBRUEsT0FBTyxLQUFLLEdBQUcsTUFBTSxLQUFLLENBQUM7QUEwQjNCLGdCQUFnQjtBQUNoQixNQUFNLENBQUMsTUFBTSxrQkFBa0IsR0FBb0QsRUFBRSxDQUFDO0FBRXRGLEtBQUssVUFBVSxlQUFlLENBQUksRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFrQjtJQUNsRSxNQUFNLENBQUMsR0FBRyxXQUFXLENBQUMsR0FBRyxFQUFFLENBQUM7SUFFNUIsSUFBSSxpQkFBaUIsSUFBSSxNQUFNLEVBQUUsQ0FBQztRQUNoQyxNQUFNLEtBQUssR0FBVSxNQUFPLE1BQWMsQ0FBQyxlQUFlLEVBQUUsQ0FBQztRQUM3RCxPQUFPLENBQUMsR0FBRyxDQUFDLG9CQUFvQixFQUFFLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUVoRCxNQUFNLEVBQUUsR0FBRyxNQUFNLEdBQUcsQ0FBQyxNQUFNLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQyxFQUFFO1lBQy9DLE9BQU8sQ0FBQyxFQUFFO2dCQUNSLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxrQkFBa0IsRUFBRTtvQkFDdkMsT0FBTyxFQUFFLGdCQUFnQjtpQkFDMUIsQ0FBQyxDQUFDO1lBQ0wsQ0FBQztTQUNGLENBQUMsQ0FBQztRQUVILE1BQU0sV0FBVyxHQUFHLE1BQU0sT0FBTyxDQUFDLEdBQUcsQ0FDbkMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQUMsSUFBSSxFQUFDLEVBQUU7WUFDckIsTUFBTSxjQUFjLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQztZQUUzQyxPQUFPLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxDQUFDLGtCQUFrQixFQUFFLGNBQWMsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDO1FBQ2xFLENBQUMsQ0FBQyxDQUNILENBQUM7UUFFRixNQUFNLGFBQWEsR0FB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LE9BQTBDLEVBQzFDLEtBQTBCO0lBRTFCLDBCQUEwQjtJQUMxQixNQUFNLE9BQU8sQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLFNBQVMsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUUzQyxPQUFPLE1BQU0sSUFBSSxnQkFBZ0IsRUFBSyxDQUFDLEtBQUssQ0FBQyxPQUFPLEVBQUUsSUFBSSxPQUFPLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQztBQUM5RSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQmVmb3JlQnVpbGRNYXJrLCBJbml0T3B0aW9ucyB9IGZyb20gJy4vb3B0aW9ucy5pbml0Lm1qcyc7XHJcbmltcG9ydCB7IExhenlXYXNtTW9kdWxlIH0gZnJvbSAnLi93YXNtLm1qcyc7XHJcbmltcG9ydCAqIGFzIGlkYiBmcm9tICdpZGInO1xyXG5cclxuLyoqIEBpbnRlcm5hbCAqL1xyXG5leHBvcnQgaW50ZXJmYWNlIFR5cHN0Q29tbW9uQnVpbGRlcjxUPiB7XHJcbiAgZnJlZSgpOiB2b2lkO1xyXG5cclxuICBhZGRfcmF3X2ZvbnQoZm9udF9idWZmZXI6IFVpbnQ4QXJyYXkpOiBQcm9taXNlPHZvaWQ+O1xyXG5cclxuICBhZGRfd2ViX2ZvbnRzKGZvbnQ6IGFueVtdKTogUHJvbWlzZTx2b2lkPjtcclxuXHJcbiAgYnVpbGQoKTogUHJvbWlzZTxUPjtcclxufVxyXG5cclxuLyoqIEBpbnRlcm5hbCAqL1xyXG5leHBvcnQgaW50ZXJmYWNlIENvbXBvbmVudEJ1aWxkSG9va3Mge1xyXG4gIGxhdGVseUJ1aWxkPzogKGN0eDogdW5rbm93bikgPT4gdm9pZDtcclxufVxyXG5cclxuaW50ZXJmYWNlIEluaXRDb250ZXh0PFQ+IHtcclxuICByZWY6IHtcclxuICAgIGxvYWRGb250cyhidWlsZGVyOiBUeXBzdENvbW1vbkJ1aWxkZXI8VD4sIGZvbnRzOiAoc3RyaW5nIHwgVWludDhBcnJheSlbXSk6IFByb21pc2U8dm9pZD47XHJcbiAgfTtcclxuICBidWlsZGVyOiBUeXBzdENvbW1vbkJ1aWxkZXI8VD47XHJcbiAgaG9va3M6IENvbXBvbmVudEJ1aWxkSG9va3M7XHJcbn1cclxuXHJcbi8qKiBAaW50ZXJuYWwgKi9cclxuZXhwb3J0IGNvbnN0IGdsb2JhbEZvbnRQcm9taXNlczogUHJvbWlzZTx7IGJ1ZmZlcjogQXJyYXlCdWZmZXI7IGlkeDogbnVtYmVyIH0+W10gPSBbXTtcclxuXHJcbmFzeW5jIGZ1bmN0aW9uIGFkZFBhcnRpYWxGb250czxUPih7IGJ1aWxkZXIsIGhvb2tzIH06IEluaXRDb250ZXh0PFQ+KTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgY29uc3QgdCA9IHBlcmZvcm1hbmNlLm5vdygpO1xyXG5cclxuICBpZiAoJ3F1ZXJ5TG9jYWxGb250cycgaW4gd2luZG93KSB7XHJcbiAgICBjb25zdCBmb250czogYW55W10gPSBhd2FpdCAod2luZG93IGFzIGFueSkucXVlcnlMb2NhbEZvbnRzKCk7XHJcbiAgICBjb25zb2xlLmxvZygnbG9jYWwgZm9udHMgY291bnQ6JywgZm9udHMubGVuZ3RoKTtcclxuXHJcbiAgICBjb25zdCBkYiA9IGF3YWl0IGlkYi5vcGVuREIoJ3R5cHN0LXRzLXN0b3JlJywgMSwge1xyXG4gICAgICB1cGdyYWRlKGRiKSB7XHJcbiAgICAgICAgZGIuY3JlYXRlT2JqZWN0U3RvcmUoJ2ZvbnQtaW5mb3JtYXRpb24nLCB7XHJcbiAgICAgICAgICBrZXlQYXRoOiAncG9zdHNjcmlwdE5hbWUnLFxyXG4gICAgICAgIH0pO1xyXG4gICAgICB9LFxyXG4gICAgfSk7XHJcblxyXG4gICAgY29uc3QgaW5mb3JtYXRpb24gPSBhd2FpdCBQcm9taXNlLmFsbChcclxuICAgICAgZm9udHMubWFwKGFzeW5jIGZvbnQgPT4ge1xyXG4gICAgICAgIGNvbnN0IHBvc3RzY3JpcHROYW1lID0gZm9udC5wb3N0c2NyaXB0TmFtZTtcclxuXHJcbiAgICAgICAgcmV0dXJuIChhd2FpdCBkYi5nZXQoJ2ZvbnQtaW5mb3JtYXRpb24nLCBwb3N0c2NyaXB0TmFtZSkpPy5pbmZvO1xyXG4gICAgICB9KSxcclxuICAgICk7XHJcblxyXG4gICAgY29uc3QgZ2V0X2ZvbnRfaW5mbyA9IChidWlsZGVyIGFzIGFueSkuaGFuZGxlcl9mb3JfZm9udF9pbmZvKCk7XHJcblxyXG4gICAgYXdhaXQgYnVpbGRlci5hZGRfd2ViX2ZvbnRzKFxyXG4gICAgICBmb250cy5tYXAoKGZvbnQsIGZvbnRfaWR4KSA9PiB7XHJcbiAgICAgICAgbGV0IGdldHRpbmdCdWZmZXIgPSBmYWxzZTtcclxuICAgICAgICBsZXQgcmVhZHlCdWZmZXI6IEFycmF5QnVmZmVyIHwgdW5kZWZpbmVkID0gdW5kZWZpbmVkO1xyXG4gICAgICAgIGNvbnN0IGZ1bGxOYW1lID0gZm9udC5mdWxsTmFtZTtcclxuICAgICAgICBjb25zdCBwb3N0c2NyaXB0TmFtZSA9IGZvbnQucG9zdHNjcmlwdE5hbWU7XHJcblxyXG4gICAgICAgIGNvbnN0IHByZXYgPSBpbmZvcm1hdGlvbltmb250X2lkeF07XHJcbiAgICAgICAgaWYgKHByZXYpIHtcclxuICAgICAgICAgIGNvbnNvbGUubG9nKCdwcmV2JywgcG9zdHNjcmlwdE5hbWUsIHByZXYpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgZmFtaWx5OiBmb250LmZhbWlseSxcclxuICAgICAgICAgIHN0eWxlOiBmb250LnN0eWxlLFxyXG4gICAgICAgICAgZnVsbE5hbWU6IGZ1bGxOYW1lLFxyXG4gICAgICAgICAgcG9zdHNjcmlwdE5hbWU6IHBvc3RzY3JpcHROYW1lLFxyXG4gICAgICAgICAgcmVmOiBmb250LFxyXG4gICAgICAgICAgaW5mbzogaW5mb3JtYXRpb25bZm9udF9pZHhdLFxyXG4gICAgICAgICAgYmxvYjogKGlkeDogbnVtYmVyKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKHRoaXMsIGZvbnQsIGlkeCk7XHJcbiAgICAgICAgICAgIGlmIChyZWFkeUJ1ZmZlcikge1xyXG4gICAgICAgICAgICAgIHJldHVybiByZWFkeUJ1ZmZlcjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoZ2V0dGluZ0J1ZmZlcikge1xyXG4gICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBnZXR0aW5nQnVmZmVyID0gdHJ1ZTtcclxuICAgICAgICAgICAgZ2xvYmFsRm9udFByb21pc2VzLnB1c2goXHJcbiAgICAgICAgICAgICAgKGFzeW5jICgpID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGJsb2I6IEJsb2IgPSBhd2FpdCBmb250LmJsb2IoKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGJ1ZmZlciA9IGF3YWl0IGJsb2IuYXJyYXlCdWZmZXIoKTtcclxuICAgICAgICAgICAgICAgIHJlYWR5QnVmZmVyID0gYnVmZmVyO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgcmVhbEZvbnRJbmZvID0gZ2V0X2ZvbnRfaW5mbyhuZXcgVWludDhBcnJheShidWZmZXIpKTtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKHJlYWxGb250SW5mbyk7XHJcblxyXG4gICAgICAgICAgICAgICAgZGIucHV0KCdmb250LWluZm9ybWF0aW9uJywge1xyXG4gICAgICAgICAgICAgICAgICBmdWxsTmFtZSxcclxuICAgICAgICAgICAgICAgICAgcG9zdHNjcmlwdE5hbWUsXHJcbiAgICAgICAgICAgICAgICAgIGluZm86IHJlYWxGb250SW5mbyxcclxuICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgICAgIHJldHVybiB7IGJ1ZmZlciwgaWR4IH07XHJcbiAgICAgICAgICAgICAgfSkoKSxcclxuICAgICAgICAgICAgKTtcclxuICAgICAgICAgIH0sXHJcbiAgICAgICAgfTtcclxuICAgICAgfSksXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgY29uc3QgdDIgPSBwZXJmb3JtYW5jZS5ub3coKTtcclxuICBjb25zb2xlLmxvZygnYWRkUGFydGlhbEZvbnRzIHRpbWUgdXNlZDonLCB0MiAtIHQpO1xyXG59XHJcblxyXG5jbGFzcyBDb21wb25lbnRCdWlsZGVyPFQ+IHtcclxuICBsb2FkZWRGb250cyA9IG5ldyBTZXQ8c3RyaW5nPigpO1xyXG4gIGZldGNoZXI/OiB0eXBlb2YgZmV0Y2ggPSBmZXRjaDtcclxuXHJcbiAgc2V0RmV0Y2hlcihmZXRjaGVyOiB0eXBlb2YgZmV0Y2gpOiB2b2lkIHtcclxuICAgIHRoaXMuZmV0Y2hlciA9IGZldGNoZXI7XHJcbiAgfVxyXG5cclxuICBhc3luYyBsb2FkRm9udHMoYnVpbGRlcjogVHlwc3RDb21tb25CdWlsZGVyPFQ+LCBmb250czogKHN0cmluZyB8IFVpbnQ4QXJyYXkpW10pOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIGNvbnN0IGVzY2FwZUltcG9ydCA9IG5ldyBGdW5jdGlvbignbScsICdyZXR1cm4gaW1wb3J0KG0pJyk7XHJcbiAgICBjb25zdCBmZXRjaGVyID0gKHRoaXMuZmV0Y2hlciB8fD0gYXdhaXQgKGFzeW5jIGZ1bmN0aW9uICgpIHtcclxuICAgICAgY29uc3QgeyBmZXRjaEJ1aWxkZXIsIEZpbGVTeXN0ZW1DYWNoZSB9ID0gYXdhaXQgZXNjYXBlSW1wb3J0KCdub2RlLWZldGNoLWNhY2hlJyk7XHJcbiAgICAgIGNvbnN0IGNhY2hlID0gbmV3IEZpbGVTeXN0ZW1DYWNoZSh7XHJcbiAgICAgICAgLy8vIEJ5IGRlZmF1bHQsIHdlIGRvbid0IGhhdmUgYSBjb21wbGljYXRlZCBjYWNoZSBwb2xpY3kuXHJcbiAgICAgICAgY2FjaGVEaXJlY3Rvcnk6ICcuY2FjaGUvdHlwc3QvZm9udHMnLFxyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIGNvbnN0IGNhY2hlZEZldGNoZXIgPSBmZXRjaEJ1aWxkZXIud2l0aENhY2hlKGNhY2hlKTtcclxuXHJcbiAgICAgIHJldHVybiBmdW5jdGlvbiAoaW5wdXQ6IFJlcXVlc3RJbmZvIHwgVVJMLCBpbml0PzogUmVxdWVzdEluaXQpIHtcclxuICAgICAgICBjb25zdCB0aW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgICAgICBjb25zb2xlLndhcm4oJ2ZvbnQgZmV0Y2hpbmcgaXMgc3R1Y2tpbmc6JywgaW5wdXQpO1xyXG4gICAgICAgIH0sIDE1MDAwKTtcclxuICAgICAgICByZXR1cm4gY2FjaGVkRmV0Y2hlcihpbnB1dCwgaW5pdCkuZmluYWxseSgoKSA9PiB7XHJcbiAgICAgICAgICBjbGVhclRpbWVvdXQodGltZW91dCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH07XHJcbiAgICB9KSgpKTtcclxuXHJcbiAgICBjb25zdCBmb250c1RvTG9hZCA9IGZvbnRzLmZpbHRlcihmb250ID0+IHtcclxuICAgICAgaWYgKGZvbnQgaW5zdGFuY2VvZiBVaW50OEFycmF5KSB7XHJcbiAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGlmICh0aGlzLmxvYWRlZEZvbnRzLmhhcyhmb250KSkge1xyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgfVxyXG5cclxuICAgICAgdGhpcy5sb2FkZWRGb250cy5hZGQoZm9udCk7XHJcbiAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfSk7XHJcblxyXG4gICAgY29uc3QgZm9udExpc3RzID0gYXdhaXQgUHJvbWlzZS5hbGwoXHJcbiAgICAgIGZvbnRzVG9Mb2FkLm1hcChhc3luYyBmb250ID0+IHtcclxuICAgICAgICBpZiAoZm9udCBpbnN0YW5jZW9mIFVpbnQ4QXJyYXkpIHtcclxuICAgICAgICAgIGF3YWl0IGJ1aWxkZXIuYWRkX3Jhd19mb250KGZvbnQpO1xyXG4gICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIG5ldyBVaW50OEFycmF5KGF3YWl0IChhd2FpdCBmZXRjaGVyKGZvbnQpKS5hcnJheUJ1ZmZlcigpKTtcclxuICAgICAgfSksXHJcbiAgICApO1xyXG5cclxuICAgIGZvciAoY29uc3QgZm9udCBvZiBmb250TGlzdHMpIHtcclxuICAgICAgaWYgKCFmb250KSB7XHJcbiAgICAgICAgY29udGludWU7XHJcbiAgICAgIH1cclxuICAgICAgYXdhaXQgYnVpbGRlci5hZGRfcmF3X2ZvbnQoZm9udCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBhc3luYyBidWlsZChcclxuICAgIG9wdGlvbnM6IFBhcnRpYWw8SW5pdE9wdGlvbnM+IHwgdW5kZWZpbmVkLFxyXG4gICAgYnVpbGRlcjogVHlwc3RDb21tb25CdWlsZGVyPFQ+LFxyXG4gICAgaG9va3M6IENvbXBvbmVudEJ1aWxkSG9va3MsXHJcbiAgKTogUHJvbWlzZTxUPiB7XHJcbiAgICAvLy8gYnVpbGQgdHlwc3QgY29tcG9uZW50XHJcbiAgICBjb25zdCBidWlsZEN0eDogSW5pdENvbnRleHQ8VD4gPSB7IHJlZjogdGhpcywgYnVpbGRlciwgaG9va3MgfTtcclxuXHJcbiAgICBmb3IgKGNvbnN0IGZuIG9mIG9wdGlvbnM/LmJlZm9yZUJ1aWxkID8/IFtdKSB7XHJcbiAgICAgIGF3YWl0IGZuKHVuZGVmaW5lZCBhcyB1bmtub3duIGFzIEJlZm9yZUJ1aWxkTWFyaywgYnVpbGRDdHgpO1xyXG4gICAgfVxyXG4gICAgLy8gYXdhaXQgYWRkUGFydGlhbEZvbnRzKGJ1aWxkQ3R4KTtcclxuXHJcbiAgICBpZiAoaG9va3MubGF0ZWx5QnVpbGQpIHtcclxuICAgICAgaG9va3MubGF0ZWx5QnVpbGQoYnVpbGRDdHgpO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGNvbXBvbmVudCA9IGF3YWl0IGJ1aWxkZXIuYnVpbGQoKTtcclxuXHJcbiAgICByZXR1cm4gY29tcG9uZW50O1xyXG4gIH1cclxufVxyXG5cclxuLyoqIEBpbnRlcm5hbCAqL1xyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gYnVpbGRDb21wb25lbnQ8VD4oXHJcbiAgb3B0aW9uczogUGFydGlhbDxJbml0T3B0aW9ucz4gfCB1bmRlZmluZWQsXHJcbiAgZ01vZHVsZTogTGF6eVdhc21Nb2R1bGUsXHJcbiAgQnVpbGRlcjogeyBuZXcgKCk6IFR5cHN0Q29tbW9uQnVpbGRlcjxUPiB9LFxyXG4gIGhvb2tzOiBDb21wb25lbnRCdWlsZEhvb2tzLFxyXG4pOiBQcm9taXNlPFQ+IHtcclxuICAvLy8gaW5pdCB0eXBzdCB3YXNtIG1vZHVsZVxyXG4gIGF3YWl0IGdNb2R1bGUuaW5pdChvcHRpb25zPy5nZXRNb2R1bGU/LigpKTtcclxuXHJcbiAgcmV0dXJuIGF3YWl0IG5ldyBDb21wb25lbnRCdWlsZGVyPFQ+KCkuYnVpbGQob3B0aW9ucywgbmV3IEJ1aWxkZXIoKSwgaG9va3MpO1xyXG59XHJcbiJdfQ==