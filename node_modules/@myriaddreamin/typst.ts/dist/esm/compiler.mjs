import { buildComponent } from './init.mjs';
import { kObject } from './internal.types.mjs';
import { preloadRemoteFonts } from './options.init.mjs';
import { LazyWasmModule } from './wasm.mjs';
export class IncrementalServer {
    /**
     * @internal
     */
    [kObject];
    /**
     * @internal
     */
    constructor(s) {
        this[kObject] = s;
    }
    /**
     * Reset the incremental server to the initial state.
     */
    reset() {
        this[kObject].reset();
    }
    /**
     * Return current result.
     */
    current() {
        return this[kObject].current();
    }
    /**
     * Also attach the debug info to the result.
     */
    setAttachDebugInfo(enable) {
        this[kObject].set_attach_debug_info(enable);
    }
}
const gCompilerModule = new LazyWasmModule(async (bin) => {
    const module = await import('@myriaddreamin/typst-ts-web-compiler');
    return await module.default(bin);
});
/**
 * create a Typst compiler.
 * @returns {TypstCompiler} - The Typst compiler.
 * @example
 * ```typescript
 * import { createTypstCompiler } from 'typst';
 * const compiler = createTypstCompiler();
 * await compiler.init();
 * compiler.addSource('/main.typ', 'Hello, typst!');
 * await compiler.compile({ mainFilePath: '/main.typ' });
 * ```
 */
export function createTypstCompiler() {
    return new TypstCompilerDriver();
}
class TypstCompilerDriver {
    compiler;
    compilerJs;
    static defaultAssets = ['text'];
    constructor() { }
    async init(options) {
        this.compilerJs = await import('@myriaddreamin/typst-ts-web-compiler');
        const TypstCompilerBuilder = this.compilerJs.TypstCompilerBuilder;
        const compilerOptions = { ...(options || {}) };
        const beforeBuild = (compilerOptions.beforeBuild ??= []);
        const hasPreloadRemoteFonts = beforeBuild.some((fn) => fn._preloadRemoteFontOptions !== undefined);
        const hasSpecifiedAssets = beforeBuild.some((fn) => fn._preloadRemoteFontOptions?.assets !== undefined);
        const hasDisableAssets = beforeBuild.some((fn) => fn._preloadRemoteFontOptions?.assets === false);
        if (!hasPreloadRemoteFonts || (!hasSpecifiedAssets && !hasDisableAssets)) {
            beforeBuild.push(preloadRemoteFonts([], { assets: TypstCompilerDriver.defaultAssets }));
        }
        const hasFontLoader = beforeBuild.some((fn) => fn._kind === 'fontLoader');
        if (!hasFontLoader) {
            throw new Error('TypstCompiler: no font loader found, please use font loaders, e.g. preloadRemoteFonts or preloadSystemFonts');
        }
        this.compiler = await buildComponent(options, gCompilerModule, TypstCompilerBuilder, {});
    }
    compile(options) {
        return new Promise(resolve => {
            if ('incrementalServer' in options) {
                resolve(this.compiler.incr_compile(options.mainFilePath, convertInputs(options.inputs), options.incrementalServer[kObject], getDiagnosticsArg(options.diagnostics)));
                return;
            }
            resolve(this.compiler.compile(options.mainFilePath, convertInputs(options.inputs), options.format || 'vector', getDiagnosticsArg(options.diagnostics)));
        });
    }
    query(options) {
        return new Promise(resolve => {
            resolve(JSON.parse(this.compiler.query(options.mainFilePath, convertInputs(options.inputs), options.selector, options.field)));
        });
    }
    getSemanticTokenLegend() {
        return new Promise(resolve => {
            resolve(this.compiler.get_semantic_token_legend());
        });
    }
    getSemanticTokens(opts) {
        return new Promise(resolve => {
            this.compiler.reset();
            resolve(this.compiler.get_semantic_tokens(opts.offsetEncoding || 'utf-16', opts.mainFilePath, opts.resultId));
        });
    }
    async withIncrementalServer(f) {
        const srv = new IncrementalServer(this.compiler.create_incr_server());
        try {
            return await f(srv);
        }
        finally {
            srv[kObject].free();
        }
    }
    async getAst(mainFilePath) {
        return this.compiler.get_ast(mainFilePath);
    }
    async reset() {
        await new Promise(resolve => {
            this.compiler.reset();
            resolve(undefined);
        });
    }
    addSource(path, source) {
        if (arguments.length > 2) {
            throw new Error('use of addSource(path, source, isMain) is deprecated, please use addSource(path, source) instead');
        }
        this.compiler.add_source(path, source);
    }
    mapShadow(path, content) {
        this.compiler.map_shadow(path, content);
    }
    unmapShadow(path) {
        this.compiler.unmap_shadow(path);
    }
    resetShadow() {
        this.compiler.reset_shadow();
    }
    renderPageToCanvas() {
        throw new Error('Please use the api TypstRenderer.renderToCanvas in v0.4.0');
    }
}
createTypstCompiler._impl = TypstCompilerDriver;
// todo: caching inputs
function convertInputs(inputs) {
    return inputs ? Object.entries(inputs) : undefined;
}
function getDiagnosticsArg(diagnostics) {
    switch (diagnostics) {
        case 'none':
            return 1;
        case 'unix':
            return 2;
        case 'full':
        default:
            return 3;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tcGlsZXIubWpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2NvbXBpbGVyLm10cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFFQSxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sWUFBWSxDQUFDO0FBQzVDLE9BQU8sRUFBd0MsT0FBTyxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFFckYsT0FBTyxFQUFFLGtCQUFrQixFQUFvQixNQUFNLG9CQUFvQixDQUFDO0FBQzFFLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxZQUFZLENBQUM7QUErSDVDLE1BQU0sT0FBTyxpQkFBaUI7SUFDNUI7O09BRUc7SUFDSCxDQUFDLE9BQU8sQ0FBQyxDQUFtQjtJQUU1Qjs7T0FFRztJQUNILFlBQVksQ0FBbUI7UUFDN0IsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNwQixDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLO1FBQ0gsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLEtBQUssRUFBRSxDQUFDO0lBQ3hCLENBQUM7SUFFRDs7T0FFRztJQUNILE9BQU87UUFDTCxPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQztJQUNqQyxDQUFDO0lBRUQ7O09BRUc7SUFDSCxrQkFBa0IsQ0FBQyxNQUFlO1FBQ2hDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxxQkFBcUIsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUM5QyxDQUFDO0NBQ0Y7QUEySEQsTUFBTSxlQUFlLEdBQUcsSUFBSSxjQUFjLENBQUMsS0FBSyxFQUFFLEdBQVMsRUFBRSxFQUFFO0lBQzdELE1BQU0sTUFBTSxHQUFHLE1BQU0sTUFBTSxDQUFDLHNDQUFzQyxDQUFDLENBQUM7SUFDcEUsT0FBTyxNQUFNLE1BQU0sQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUM7QUFDbkMsQ0FBQyxDQUFDLENBQUM7QUFFSDs7Ozs7Ozs7Ozs7R0FXRztBQUNI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QUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDO0FBQ3JELENBQUM7QUFFRCxTQUFTLGlCQUFpQixDQUFDLFdBQStCO0lBQ3hELFFBQVEsV0FBVyxFQUFFLENBQUM7UUFDcEIsS0FBSyxNQUFNO1lBQ1QsT0FBTyxDQUFDLENBQUM7UUFDWCxLQUFLLE1BQU07WUFDVCxPQUFPLENBQUMsQ0FBQztRQUNYLEtBQUssTUFBTSxDQUFDO1FBQ1o7WUFDRSxPQUFPLENBQUMsQ0FBQztJQUNiLENBQUM7QUFDSCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQHRzLWlnbm9yZVxyXG5pbXBvcnQgdHlwZSAqIGFzIHR5cHN0IGZyb20gJ0BteXJpYWRkcmVhbWluL3R5cHN0LXRzLXdlYi1jb21waWxlcic7XHJcbmltcG9ydCB7IGJ1aWxkQ29tcG9uZW50IH0gZnJvbSAnLi9pbml0Lm1qcyc7XHJcbmltcG9ydCB7IFNlbWFudGljVG9rZW5zLCBTZW1hbnRpY1Rva2Vuc0xlZ2VuZCwga09iamVjdCB9IGZyb20gJy4vaW50ZXJuYWwudHlwZXMubWpzJztcclxuXHJcbmltcG9ydCB7IHByZWxvYWRSZW1vdGVGb250cywgdHlwZSBJbml0T3B0aW9ucyB9IGZyb20gJy4vb3B0aW9ucy5pbml0Lm1qcyc7XHJcbmltcG9ydCB7IExhenlXYXNtTW9kdWxlIH0gZnJvbSAnLi93YXNtLm1qcyc7XHJcblxyXG4vKipcclxuICogQXZhaWxhYmxlIGZvcm1hdHMgZm9yIGNvbXBpbGluZyB0aGUgZG9jdW1lbnQuXHJcbiAqL1xyXG5leHBvcnQgdHlwZSBDb21waWxlRm9ybWF0ID0gJ3ZlY3RvcicgfCAncGRmJztcclxuXHJcbi8qKlxyXG4gKiBUaGUgZGlhZ25vc3RpYyBtZXNzYWdlIHBhcnRpYWxseSBmb2xsb3dpbmcgdGhlIExTUCBzcGVjaWZpY2F0aW9uLlxyXG4gKi9cclxuaW50ZXJmYWNlIERpYWdub3N0aWNNZXNzYWdlIHtcclxuICAvLyBUaGUgcGFja2FnZSBvd25pbmcgdGhlIHBhdGguXHJcbiAgLy8gSWYgdGhlIHBhY2thZ2UgaXMgZW1wdHksIHRoZSBwYXRoIGlzIGEgcmVsYXRpdmUgcGF0aCB0byB0aGUgKndvcmtzcGFjZSByb290Ki5cclxuICBwYWNrYWdlOiBzdHJpbmc7XHJcbiAgLy8gVGhlIHBhdGggb2YgdGhlIGZpbGUuXHJcbiAgcGF0aDogc3RyaW5nO1xyXG4gIC8vIFNldmVyaXR5IG9mIHRoZSBkaWFnbm9zdGljIG1lc3NhZ2UuXHJcbiAgc2V2ZXJpdHk6IHN0cmluZztcclxuICAvLyBaZXJvLWJhc2VkIGxpbmUgbnVtYmVyIGFuZCBvbmUtYmFzZWQgY2hhcmFjdGVyIG9mZnNldC5cclxuICAvLyBUaGUgcmFuZ2Ugb2YgdGhlIGRpYWdub3N0aWMgbWVzc2FnZS5cclxuICAvLyBJZiB0aGUgZGlhZ25vc3RpYyBtZXNzYWdlIGlzIGEgcmFuZ2UsIHRoZSByYW5nZSBpcyBpbiB0aGUgZm9ybWF0IG9mIGBzdGFydExpbmU6c3RhcnRDaGFyYWN0ZXItZW5kTGluZTplbmRDaGFyYWN0ZXJgLlxyXG4gIC8vIElmIHRoZSBkaWFnbm9zdGljIG1lc3NhZ2UgaXMgYSBwb2ludCwgdGhlIHJhbmdlIGlzIGluIHRoZSBmb3JtYXQgb2YgYGxpbmU6Y2hhcmFjdGVyYC5cclxuICAvLyBPdGhlcndpc2UsIHRoZSByYW5nZSBpcyBlbXB0eS5cclxuICByYW5nZTogc3RyaW5nO1xyXG4gIC8vIFRoZSBtZXNzYWdlIG9mIHRoZSBkaWFnbm9zdGljIG1lc3NhZ2UuXHJcbiAgbWVzc2FnZTogc3RyaW5nO1xyXG59XHJcblxyXG4vKipcclxuICogQXZhaWxhYmxlIGZvcm1hdHMgZm9yIGNvbXBpbGluZyB0aGUgZG9jdW1lbnQuXHJcbiAqXHJcbiAqIElmIHNldCB0byB1bml4LCBhIGRpYWdub3N0aWNzIGlzIGluIGZvcm1hdCBvZlxyXG4gKlxyXG4gKiBgYGBsb2dcclxuICogLy8gd2l0aCBwYWNrYWdlXHJcbiAqIGNldHo6MC4yLjBAbGliLnR5cDoyOjktMzoxNTogZXJyb3I6IHVuZXhwZWN0ZWQgdHlwZSBpbiBgK2AgYXBwbGljYXRpb25cclxuICogLy8gd2l0aG91dCBwYWNrYWdlXHJcbiAqIG1haW4udHlwOjI6OS0zOjE1OiBlcnJvcjogdW5leHBlY3RlZCB0eXBlIGluIGArYCBhcHBsaWNhdGlvblxyXG4gKiBgYGBcclxuICpcclxuICogSWYgc2V0IHRvIGxvbmcsIGEgZGlhZ25vc3RpY3MgaXMgaW4gZm9ybWF0IG9mIHtAbGluayBEaWFnbm9zdGljTWVzc2FnZX0uXHJcbiAqXHJcbiAqIElmIHNldCB0byBmdWxsLCBhIGRpYWdub3N0aWNzIGlzIGluIGZvcm1hdCBvZiB7QGxpbmsgRGlhZ25vc3RpY01lc3NhZ2V9LCBidXQgYWxzbyB3aXRoIHRyYWNlIG1lc3NhZ2VzLlxyXG4gKi9cclxuZXhwb3J0IHR5cGUgRGlhZ25vc3RpY3NGb3JtYXQgPSAnbm9uZScgfCAndW5peCcgfCAnZnVsbCc7XHJcblxyXG5leHBvcnQgdHlwZSBEaWFnbm9zdGljc0RhdGEgPSB7XHJcbiAgbm9uZTogbmV2ZXI7XHJcbiAgdW5peDogc3RyaW5nO1xyXG4gIGZ1bGw6IERpYWdub3N0aWNNZXNzYWdlO1xyXG59O1xyXG5cclxuaW50ZXJmYWNlIENvbXBpbGVPcHRpb25zQ29tbW9uIHtcclxuICAvKipcclxuICAgKiBUaGUgcGF0aCBvZiB0aGUgbWFpbiBmaWxlLlxyXG4gICAqL1xyXG4gIG1haW5GaWxlUGF0aDogc3RyaW5nO1xyXG4gIC8qKlxyXG4gICAqIEFkZHMgYSBzdHJpbmcga2V5LXZhbHVlIHBhaXIgdmlzaWJsZSB0aHJvdWdoIGBzeXMuaW5wdXRzYFxyXG4gICAqXHJcbiAgICogTm90ZTogcGFzcyBge31gIHRvIGNsZWFyIGBzeXMuaW5wdXRzYFxyXG4gICAqXHJcbiAgICogTm90ZTogV2hlbiBwYXNzaW5nIGB1bmRlZmluZWRgLCBjb21waWxlciB3aWxsIHVzZSBsYXN0IHNldCBgc3lzLmlucHV0c2AuXHJcbiAgICpcclxuICAgKiBOb3RlOiBUaGlzIG1lYW5zIHlvdSBzaG91bGQgYWx3YXlzIHNwZWNpZnkgaW5wdXRzIHdoZW4gdXNpbmcgY29tcGlsZXIgZm9yIGNvbmN1cnJlbnQgdGFza3MuXHJcbiAgICovXHJcbiAgaW5wdXRzPzogUmVjb3JkPHN0cmluZywgc3RyaW5nPjtcclxufVxyXG5cclxuaW50ZXJmYWNlIFRyYW5zaWVudENvbXBpbGVPcHRpb25zPFxyXG4gIEYgZXh0ZW5kcyBDb21waWxlRm9ybWF0ID0gYW55LFxyXG4gIERpYWdub3N0aWNzIGV4dGVuZHMgRGlhZ25vc3RpY3NGb3JtYXQgPSBEaWFnbm9zdGljc0Zvcm1hdCxcclxuPiBleHRlbmRzIENvbXBpbGVPcHRpb25zQ29tbW9uIHtcclxuICAvKipcclxuICAgKiBUaGUgZm9ybWF0IG9mIHRoZSBhcnRpZmFjdC5cclxuICAgKiAtICd2ZWN0b3InOiBjYW4gdGhlbiBsb2FkIHRvIHRoZSByZW5kZXJlciB0byByZW5kZXIgdGhlIGRvY3VtZW50LlxyXG4gICAqIC0gJ3BkZic6IGZvciBmaW5hbGx5IGV4cG9ydGluZyBwZGYgdG8gdGhlIHVzZXIuXHJcbiAgICogQGRlZmF1bHQgJ3ZlY3RvcidcclxuICAgKi9cclxuICBmb3JtYXQ/OiBGO1xyXG4gIC8qKlxyXG4gICAqIFdoZXRoZXIgdG8gaW5jbHVkZSBkaWFnbm9zdGljIGluZm9ybWF0aW9uIGluIHRoZSByZXN1bHQuXHJcbiAgICogTm90ZTogaXQgd2lsbCBiZSBzZXQgdG8gJ2Z1bGwnIGJ5IGRlZmF1bHQgaW4gdjAuNi4wXHJcbiAgICogQGRlZmF1bHQgJ2Z1bGwnXHJcbiAgICovXHJcbiAgZGlhZ25vc3RpY3M/OiBEaWFnbm9zdGljcztcclxufVxyXG5cclxuaW50ZXJmYWNlIEluY3JlbWVudGFsQ29tcGlsZU9wdGlvbnM8RGlhZ25vc3RpY3MgZXh0ZW5kcyBEaWFnbm9zdGljc0Zvcm1hdCA9IERpYWdub3N0aWNzRm9ybWF0PlxyXG4gIGV4dGVuZHMgQ29tcGlsZU9wdGlvbnNDb21tb24ge1xyXG4gIC8qKlxyXG4gICAqIFRoZSBmb3JtYXQgb2YgdGhlIGluY3JlbWVudGFsbHkgZXhwb3J0ZWQgYXJ0aWZhY3QuXHJcbiAgICogQGRlZmF1bHQgJ3ZlY3RvcidcclxuICAgKi9cclxuICBmb3JtYXQ/OiAndmVjdG9yJztcclxuICAvKipcclxuICAgKiBUaGUgaW5jcmVtZW50YWwgc2VydmVyIGZvciB0aGUgZG9jdW1lbnQuXHJcbiAgICovXHJcbiAgaW5jcmVtZW50YWxTZXJ2ZXI6IEluY3JlbWVudGFsU2VydmVyO1xyXG4gIC8qKlxyXG4gICAqIFdoZXRoZXIgdG8gaW5jbHVkZSBkaWFnbm9zdGljIGluZm9ybWF0aW9uIGluIHRoZSByZXN1bHQuXHJcbiAgICogTm90ZTogQmVmb3JlIHYwLjYuMCwgd2hlbiBkaWFnbm9zdGljcyBpcyBub3Qgc2V0LCB0aGUgcmVzdWx0IHdpbGwgYmUgYSBVaW50OEFycmF5LlxyXG4gICAqIEFmdGVyIHYwLjYuMCwgd2hlbiBkaWFnbm9zdGljcyBpcyBub3Qgc2V0LCB0aGUgcmVzdWx0IHdpbGwgYmUgYSBDb21waWxlUmVzdWx0PFVpbnQ4QXJyYXk+IHdpdGhvdXQgZGlhZ25vc3RpY3MuXHJcbiAgICogQGRlZmF1bHQgJ2Z1bGwnXHJcbiAgICovXHJcbiAgZGlhZ25vc3RpY3M/OiBEaWFnbm9zdGljcztcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBRdWVyeU9wdGlvbnMgZXh0ZW5kcyBDb21waWxlT3B0aW9uc0NvbW1vbiB7XHJcbiAgLyoqXHJcbiAgICogc2VsZWN0IHBhcnQgb2YgZG9jdW1lbnQgZm9yIHF1ZXJ5LlxyXG4gICAqL1xyXG4gIHNlbGVjdG9yOiBzdHJpbmc7XHJcbiAgLyoqXHJcbiAgICogY2FzdCByZXN1bHQgYnkgYWNjZXNzaW5nIHNpbmdsZSBmaWVsZC5cclxuICAgKi9cclxuICBmaWVsZD86IHN0cmluZztcclxufVxyXG5cclxuLyoqXHJcbiAqIFRoZSBvcHRpb25zIGZvciBjb21waWxpbmcgdGhlIGRvY3VtZW50LlxyXG4gKi9cclxuZXhwb3J0IHR5cGUgQ29tcGlsZU9wdGlvbnM8XHJcbiAgRm9ybWF0IGV4dGVuZHMgQ29tcGlsZUZvcm1hdCA9IGFueSxcclxuICBEaWFnbm9zdGljcyBleHRlbmRzIERpYWdub3N0aWNzRm9ybWF0ID0gRGlhZ25vc3RpY3NGb3JtYXQsXHJcbj4gPSBUcmFuc2llbnRDb21waWxlT3B0aW9uczxGb3JtYXQsIERpYWdub3N0aWNzPiB8IEluY3JlbWVudGFsQ29tcGlsZU9wdGlvbnM7XHJcblxyXG5leHBvcnQgY2xhc3MgSW5jcmVtZW50YWxTZXJ2ZXIge1xyXG4gIC8qKlxyXG4gICAqIEBpbnRlcm5hbFxyXG4gICAqL1xyXG4gIFtrT2JqZWN0XTogdHlwc3QuSW5jclNlcnZlcjtcclxuXHJcbiAgLyoqXHJcbiAgICogQGludGVybmFsXHJcbiAgICovXHJcbiAgY29uc3RydWN0b3IoczogdHlwc3QuSW5jclNlcnZlcikge1xyXG4gICAgdGhpc1trT2JqZWN0XSA9IHM7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBSZXNldCB0aGUgaW5jcmVtZW50YWwgc2VydmVyIHRvIHRoZSBpbml0aWFsIHN0YXRlLlxyXG4gICAqL1xyXG4gIHJlc2V0KCk6IHZvaWQge1xyXG4gICAgdGhpc1trT2JqZWN0XS5yZXNldCgpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUmV0dXJuIGN1cnJlbnQgcmVzdWx0LlxyXG4gICAqL1xyXG4gIGN1cnJlbnQoKTogVWludDhBcnJheSB8IHVuZGVmaW5lZCB7XHJcbiAgICByZXR1cm4gdGhpc1trT2JqZWN0XS5jdXJyZW50KCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBBbHNvIGF0dGFjaCB0aGUgZGVidWcgaW5mbyB0byB0aGUgcmVzdWx0LlxyXG4gICAqL1xyXG4gIHNldEF0dGFjaERlYnVnSW5mbyhlbmFibGU6IGJvb2xlYW4pOiB2b2lkIHtcclxuICAgIHRoaXNba09iamVjdF0uc2V0X2F0dGFjaF9kZWJ1Z19pbmZvKGVuYWJsZSk7XHJcbiAgfVxyXG59XHJcblxyXG5pbnRlcmZhY2UgQ29tcGlsZVJlc3VsdDxULCBEIGV4dGVuZHMgRGlhZ25vc3RpY3NGb3JtYXQ+IHtcclxuICByZXN1bHQ/OiBUO1xyXG4gIGRpYWdub3N0aWNzPzogRGlhZ25vc3RpY3NEYXRhW0RdW107XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBUaGUgaW50ZXJmYWNlIG9mIFR5cHN0IGNvbXBpbGVyLlxyXG4gKi9cclxuZXhwb3J0IGludGVyZmFjZSBUeXBzdENvbXBpbGVyIHtcclxuICAvKipcclxuICAgKiBJbml0aWFsaXplIHRoZSB0eXBzdCBjb21waWxlci5cclxuICAgKiBAcGFyYW0ge1BhcnRpYWw8SW5pdE9wdGlvbnM+fSBvcHRpb25zIC0gVGhlIG9wdGlvbnMgZm9yIGluaXRpYWxpemluZyB0aGVcclxuICAgKiB0eXBzdCBjb21waWxlci5cclxuICAgKi9cclxuICBpbml0KG9wdGlvbnM/OiBQYXJ0aWFsPEluaXRPcHRpb25zPik6IFByb21pc2U8dm9pZD47XHJcblxyXG4gIC8qKlxyXG4gICAqIFJlc2V0IHRoZSB0eXBzdCBjb21waWxlciB0byB0aGUgaW5pdGlhbCBzdGF0ZS5cclxuICAgKiBOb3RlOiB3aXRob3V0IGNhbGxpbmcgdGhpcyBmdW5jdGlvbiwgdGhlIGNvbXBpbGVyIHdpbGwgYWx3YXlzIGtlZXAgY2FjaGVzXHJcbiAgICogc3VjaCBhczpcclxuICAgKiAtIGxvYWRlZCBmb250c1xyXG4gICAqIC0gc291cmNlIGZpbGVzIGNvcnJlc3BvbmRpbmcgdG8gdHlwc3QgbW9kdWxlc1xyXG4gICAqXHJcbiAgICogTm90ZTogdGhpcyBmdW5jdGlvbiBpcyBpbmRlcGVuZGVudCB0byB0aGUge0BsaW5rIHJlc2V0U2hhZG93fSBmdW5jdGlvbi5cclxuICAgKiBUaGlzIGlzIGludGVuZGVkIHRvIG9wdGltaXplIHRoZSBwZXJmb3JtYW5jZSBvZiB0aGUgY29tcGlsZXIuXHJcbiAgICovXHJcbiAgcmVzZXQoKTogUHJvbWlzZTx2b2lkPjtcclxuXHJcbiAgLyoqXHJcbiAgICogQ29tcGlsZSBhbiBkb2N1bWVudCB3aXRoIHRoZSBtYWludGFpbmVkIHN0YXRlLlxyXG4gICAqIEBwYXJhbSB7Q29tcGlsZU9wdGlvbnN9IG9wdGlvbnMgLSBUaGUgb3B0aW9ucyBmb3IgY29tcGlsaW5nIHRoZSBkb2N1bWVudC5cclxuICAgKiBAcmV0dXJucyB7UHJvbWlzZTxVaW50OEFycmF5Pn0gLSBhcnRpZmFjdCBpbiB2ZWN0b3IgZm9ybWF0LlxyXG4gICAqIFlvdSBjYW4gdGhlbiBsb2FkIHRoZSBhcnRpZmFjdCB0byB0aGUgcmVuZGVyZXIgdG8gcmVuZGVyIHRoZSBkb2N1bWVudC5cclxuICAgKi9cclxuICBjb21waWxlPEQgZXh0ZW5kcyBEaWFnbm9zdGljc0Zvcm1hdD4oXHJcbiAgICBvcHRpb25zOiBDb21waWxlT3B0aW9uczwndmVjdG9yJywgRD4sXHJcbiAgKTogUHJvbWlzZTxDb21waWxlUmVzdWx0PFVpbnQ4QXJyYXksIEQ+PjtcclxuICBjb21waWxlPEQgZXh0ZW5kcyBEaWFnbm9zdGljc0Zvcm1hdD4oXHJcbiAgICBvcHRpb25zOiBDb21waWxlT3B0aW9uczwncGRmJywgRD4sXHJcbiAgKTogUHJvbWlzZTxDb21waWxlUmVzdWx0PFVpbnQ4QXJyYXksIEQ+PjtcclxuICBjb21waWxlPEQgZXh0ZW5kcyBEaWFnbm9zdGljc0Zvcm1hdD4oXHJcbiAgICBvcHRpb25zOiBDb21waWxlT3B0aW9uczxhbnksIEQ+LFxyXG4gICk6IFByb21pc2U8Q29tcGlsZVJlc3VsdDxVaW50OEFycmF5LCBEPj47XHJcblxyXG4gIC8qKlxyXG4gICAqIGV4cGVyaW1lbnRhbFxyXG4gICAqIFF1ZXJ5IHRoZSByZXN1bHQgd2l0aCBkb2N1bWVudFxyXG4gICAqL1xyXG4gIHF1ZXJ5PFQ+KG9wdGlvbnM6IFF1ZXJ5T3B0aW9ucyk6IFByb21pc2U8VD47XHJcblxyXG4gIC8qKlxyXG4gICAqIFByaW50IHRoZSBBU1Qgb2YgdGhlIG1haW4gZmlsZS5cclxuICAgKiBAcGFyYW0ge3N0cmluZ30gbWFpbkZpbGVQYXRoIC0gVGhlIHBhdGggb2YgdGhlIG1haW4gZmlsZS5cclxuICAgKiBAcmV0dXJucyB7UHJvbWlzZTxzdHJpbmc+fSAtIGFuIHN0cmluZyByZXByZXNlbnRhdGlvbiBvZiB0aGUgQVNULlxyXG4gICAqL1xyXG4gIGdldEFzdChtYWluRmlsZVBhdGg6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nPjtcclxuXHJcbiAgLyoqXHJcbiAgICogQWRkIGEgc291cmNlIGZpbGUgdG8gdGhlIGNvbXBpbGVyLlxyXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBwYXRoIC0gVGhlIHBhdGggb2YgdGhlIHNvdXJjZSBmaWxlLlxyXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBzb3VyY2UgLSBUaGUgc291cmNlIGNvZGUgb2YgdGhlIHNvdXJjZSBmaWxlLlxyXG4gICAqXHJcbiAgICovXHJcbiAgYWRkU291cmNlKHBhdGg6IHN0cmluZywgc291cmNlOiBzdHJpbmcpOiB2b2lkO1xyXG5cclxuICAvKipcclxuICAgKiBBZGQgYSBzaGFkb3cgZmlsZSB0byB0aGUgY29tcGlsZXIuXHJcbiAgICogQHBhcmFtIHtzdHJpbmd9IHBhdGggLSBUaGUgcGF0aCB0byB0aGUgc2hhZG93IGZpbGUuXHJcbiAgICogQHBhcmFtIHtVaW50OEFycmF5fSBjb250ZW50IC0gVGhlIGNvbnRlbnQgb2YgdGhlIHNoYWRvdyBmaWxlLlxyXG4gICAqXHJcbiAgICovXHJcbiAgbWFwU2hhZG93KHBhdGg6IHN0cmluZywgY29udGVudDogVWludDhBcnJheSk6IHZvaWQ7XHJcblxyXG4gIC8qKlxyXG4gICAqIFJlbW92ZSBhIHNoYWRvdyBmaWxlIGZyb20gdGhlIGNvbXBpbGVyLlxyXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBwYXRoIC0gVGhlIHBhdGggdG8gdGhlIHNoYWRvdyBmaWxlLlxyXG4gICAqL1xyXG4gIHVubWFwU2hhZG93KHBhdGg6IHN0cmluZyk6IHZvaWQ7XHJcblxyXG4gIC8qKlxyXG4gICAqIFJlc2V0IHRoZSBzaGFkb3cgZmlsZXMuXHJcbiAgICogTm90ZTogdGhpcyBmdW5jdGlvbiBpcyBpbmRlcGVuZGVudCB0byB0aGUge0BsaW5rIHJlc2V0fSBmdW5jdGlvbi5cclxuICAgKi9cclxuICByZXNldFNoYWRvdygpOiB2b2lkO1xyXG5cclxuICAvKipcclxuICAgKiBleHBlcmltZW50YWxcclxuICAgKiBTZWUgU2VtYW50aWMgdG9rZW5zOiBodHRwczovL2dpdGh1Yi5jb20vbWljcm9zb2Z0L3ZzY29kZS9pc3N1ZXMvODY0MTVcclxuICAgKi9cclxuICBnZXRTZW1hbnRpY1Rva2VuTGVnZW5kKCk6IFByb21pc2U8U2VtYW50aWNUb2tlbnNMZWdlbmQ+O1xyXG5cclxuICAvKipcclxuICAgKiBleHBlcmltZW50YWxcclxuICAgKiBTZWUgU2VtYW50aWMgdG9rZW5zOiBodHRwczovL2dpdGh1Yi5jb20vbWljcm9zb2Z0L3ZzY29kZS9pc3N1ZXMvODY0MTVcclxuICAgKlxyXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBvcHRzLm1haW5GaWxlUGF0aCAtIFRoZSBwYXRoIG9mIHRoZSBtYWluIGZpbGUuXHJcbiAgICogQHBhcmFtIHtzdHJpbmd9IG9wdHMucmVzdWx0SWQgLSBUaGUgaWQgb2YgdGhlIHJlc3VsdC5cclxuICAgKiBAcGFyYW0ge3N0cmluZ30gb3B0cy5vZmZzZXRFbmNvZGluZyAtIFRoZSBlbmNvZGluZyBvZiB0aGUgb2Zmc2V0LlxyXG4gICAqICAgLSAndXRmLTE2JzogdGhlIG9mZnNldCBpcyBlbmNvZGVkIGluIHV0Zi0xNi5cclxuICAgKiAgIC0gJ3V0Zi04JzogdGhlIG9mZnNldCBpcyBlbmNvZGVkIGluIHV0Zi04LlxyXG4gICAqICAgQGRlZmF1bHQgJ3V0Zi0xNidcclxuICAgKiBAcmV0dXJucyB7UHJvbWlzZTxTZW1hbnRpY1Rva2Vucz59IC0gVGhlIHNlbWFudGljIHRva2Vucy5cclxuICAgKi9cclxuICBnZXRTZW1hbnRpY1Rva2VucyhvcHRzOiB7XHJcbiAgICBtYWluRmlsZVBhdGg6IHN0cmluZztcclxuICAgIHJlc3VsdElkPzogc3RyaW5nO1xyXG4gICAgb2Zmc2V0RW5jb2Rpbmc/OiBzdHJpbmc7XHJcbiAgfSk6IFByb21pc2U8U2VtYW50aWNUb2tlbnM+O1xyXG5cclxuICAvKipcclxuICAgKiBleHBlcmltZW50YWxcclxuICAgKiBSdW4gd2l0aCBhbiBpbmNyZW1lbnRhbCBzZXJ2ZXIgd2hpY2ggaG9sZHMgdGhlIHN0YXRlIG9mIHRoZSBkb2N1bWVudCBpbiB3YXNtLlxyXG4gICAqXHJcbiAgICogQHBhcmFtIHtmdW5jdGlvbihJbmNyZW1lbnRhbFNlcnZlcik6IFByb21pc2U8VD59IGYgLSBUaGUgZnVuY3Rpb24gdG8gcnVuIHdpdGggdGhlIGluY3JlbWVudGFsIHNlcnZlci5cclxuICAgKiBAcmV0dXJucyB7UHJvbWlzZTxUPn0gLSBUaGUgcmVzdWx0IG9mIHRoZSBmdW5jdGlvbi5cclxuICAgKlxyXG4gICAqIE5vdGU6IHRoZSBpbmNyZW1lbnRhbCBzZXJ2ZXIgd2lsbCBiZSBmcmVlZCBhZnRlciB0aGUgZnVuY3Rpb24gaXMgZmluaXNoZWQuXHJcbiAgICovXHJcbiAgd2l0aEluY3JlbWVudGFsU2VydmVyPFQ+KGY6IChzOiBJbmNyZW1lbnRhbFNlcnZlcikgPT4gUHJvbWlzZTxUPik6IFByb21pc2U8VD47XHJcbn1cclxuXHJcbmNvbnN0IGdDb21waWxlck1vZHVsZSA9IG5ldyBMYXp5V2FzbU1vZHVsZShhc3luYyAoYmluPzogYW55KSA9PiB7XHJcbiAgY29uc3QgbW9kdWxlID0gYXdhaXQgaW1wb3J0KCdAbXlyaWFkZHJlYW1pbi90eXBzdC10cy13ZWItY29tcGlsZXInKTtcclxuICByZXR1cm4gYXdhaXQgbW9kdWxlLmRlZmF1bHQoYmluKTtcclxufSk7XHJcblxyXG4vKipcclxuICogY3JlYXRlIGEgVHlwc3QgY29tcGlsZXIuXHJcbiAqIEByZXR1cm5zIHtUeXBzdENvbXBpbGVyfSAtIFRoZSBUeXBzdCBjb21waWxlci5cclxuICogQGV4YW1wbGVcclxuICogYGBgdHlwZXNjcmlwdFxyXG4gKiBpbXBvcnQgeyBjcmVhdGVUeXBzdENvbXBpbGVyIH0gZnJvbSAndHlwc3QnO1xyXG4gKiBjb25zdCBjb21waWxlciA9IGNyZWF0ZVR5cHN0Q29tcGlsZXIoKTtcclxuICogYXdhaXQgY29tcGlsZXIuaW5pdCgpO1xyXG4gKiBjb21waWxlci5hZGRTb3VyY2UoJy9tYWluLnR5cCcsICdIZWxsbywgdHlwc3QhJyk7XHJcbiAqIGF3YWl0IGNvbXBpbGVyLmNvbXBpbGUoeyBtYWluRmlsZVBhdGg6ICcvbWFpbi50eXAnIH0pO1xyXG4gKiBgYGBcclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVUeXBzdENvbXBpbGVyKCk6IFR5cHN0Q29tcGlsZXIge1xyXG4gIHJldHVybiBuZXcgVHlwc3RDb21waWxlckRyaXZlcigpO1xyXG59XHJcblxyXG5jbGFzcyBUeXBzdENvbXBpbGVyRHJpdmVyIHtcclxuICBjb21waWxlcjogdHlwc3QuVHlwc3RDb21waWxlcjtcclxuICBjb21waWxlckpzOiB0eXBlb2YgdHlwc3Q7XHJcblxyXG4gIHN0YXRpYyBkZWZhdWx0QXNzZXRzID0gWyd0ZXh0JyBhcyBjb25zdF07XHJcblxyXG4gIGNvbnN0cnVjdG9yKCkge31cclxuXHJcbiAgYXN5bmMgaW5pdChvcHRpb25zPzogUGFydGlhbDxJbml0T3B0aW9ucz4pOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIHRoaXMuY29tcGlsZXJKcyA9IGF3YWl0IGltcG9ydCgnQG15cmlhZGRyZWFtaW4vdHlwc3QtdHMtd2ViLWNvbXBpbGVyJyk7XHJcbiAgICBjb25zdCBUeXBzdENvbXBpbGVyQnVpbGRlciA9IHRoaXMuY29tcGlsZXJKcy5UeXBzdENvbXBpbGVyQnVpbGRlcjtcclxuXHJcbiAgICBjb25zdCBjb21waWxlck9wdGlvbnMgPSB7IC4uLihvcHRpb25zIHx8IHt9KSB9O1xyXG4gICAgY29uc3QgYmVmb3JlQnVpbGQgPSAoY29tcGlsZXJPcHRpb25zLmJlZm9yZUJ1aWxkID8/PSBbXSk7XHJcbiAgICBjb25zdCBoYXNQcmVsb2FkUmVtb3RlRm9udHMgPSBiZWZvcmVCdWlsZC5zb21lKFxyXG4gICAgICAoZm46IGFueSkgPT4gZm4uX3ByZWxvYWRSZW1vdGVGb250T3B0aW9ucyAhPT0gdW5kZWZpbmVkLFxyXG4gICAgKTtcclxuICAgIGNvbnN0IGhhc1NwZWNpZmllZEFzc2V0cyA9IGJlZm9yZUJ1aWxkLnNvbWUoXHJcbiAgICAgIChmbjogYW55KSA9PiBmbi5fcHJlbG9hZFJlbW90ZUZvbnRPcHRpb25zPy5hc3NldHMgIT09IHVuZGVmaW5lZCxcclxuICAgICk7XHJcbiAgICBjb25zdCBoYXNEaXNhYmxlQXNzZXRzID0gYmVmb3JlQnVpbGQuc29tZShcclxuICAgICAgKGZuOiBhbnkpID0+IGZuLl9wcmVsb2FkUmVtb3RlRm9udE9wdGlvbnM/LmFzc2V0cyA9PT0gZmFsc2UsXHJcbiAgICApO1xyXG5cclxuICAgIGlmICghaGFzUHJlbG9hZFJlbW90ZUZvbnRzIHx8ICghaGFzU3BlY2lmaWVkQXNzZXRzICYmICFoYXNEaXNhYmxlQXNzZXRzKSkge1xyXG4gICAgICBiZWZvcmVCdWlsZC5wdXNoKHByZWxvYWRSZW1vdGVGb250cyhbXSwgeyBhc3NldHM6IFR5cHN0Q29tcGlsZXJEcml2ZXIuZGVmYXVsdEFzc2V0cyB9KSk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgaGFzRm9udExvYWRlciA9IGJlZm9yZUJ1aWxkLnNvbWUoKGZuOiBhbnkpID0+IGZuLl9raW5kID09PSAnZm9udExvYWRlcicpO1xyXG4gICAgaWYgKCFoYXNGb250TG9hZGVyKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcihcclxuICAgICAgICAnVHlwc3RDb21waWxlcjogbm8gZm9udCBsb2FkZXIgZm91bmQsIHBsZWFzZSB1c2UgZm9udCBsb2FkZXJzLCBlLmcuIHByZWxvYWRSZW1vdGVGb250cyBvciBwcmVsb2FkU3lzdGVtRm9udHMnLFxyXG4gICAgICApO1xyXG4gICAgfVxyXG4gICAgdGhpcy5jb21waWxlciA9IGF3YWl0IGJ1aWxkQ29tcG9uZW50KG9wdGlvbnMsIGdDb21waWxlck1vZHVsZSwgVHlwc3RDb21waWxlckJ1aWxkZXIsIHt9KTtcclxuICB9XHJcblxyXG4gIGNvbXBpbGUob3B0aW9uczogQ29tcGlsZU9wdGlvbnMpOiBQcm9taXNlPGFueT4ge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKHJlc29sdmUgPT4ge1xyXG4gICAgICBpZiAoJ2luY3JlbWVudGFsU2VydmVyJyBpbiBvcHRpb25zKSB7XHJcbiAgICAgICAgcmVzb2x2ZShcclxuICAgICAgICAgIHRoaXMuY29tcGlsZXIuaW5jcl9jb21waWxlKFxyXG4gICAgICAgICAgICBvcHRpb25zLm1haW5GaWxlUGF0aCxcclxuICAgICAgICAgICAgY29udmVydElucHV0cyhvcHRpb25zLmlucHV0cyksXHJcbiAgICAgICAgICAgIG9wdGlvbnMuaW5jcmVtZW50YWxTZXJ2ZXJba09iamVjdF0sXHJcbiAgICAgICAgICAgIGdldERpYWdub3N0aWNzQXJnKG9wdGlvbnMuZGlhZ25vc3RpY3MpLFxyXG4gICAgICAgICAgKSxcclxuICAgICAgICApO1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG4gICAgICByZXNvbHZlKFxyXG4gICAgICAgIHRoaXMuY29tcGlsZXIuY29tcGlsZShcclxuICAgICAgICAgIG9wdGlvbnMubWFpbkZpbGVQYXRoLFxyXG4gICAgICAgICAgY29udmVydElucHV0cyhvcHRpb25zLmlucHV0cyksXHJcbiAgICAgICAgICBvcHRpb25zLmZvcm1hdCB8fCAndmVjdG9yJyxcclxuICAgICAgICAgIGdldERpYWdub3N0aWNzQXJnKG9wdGlvbnMuZGlhZ25vc3RpY3MpLFxyXG4gICAgICAgICksXHJcbiAgICAgICk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHF1ZXJ5KG9wdGlvbnM6IFF1ZXJ5T3B0aW9ucyk6IFByb21pc2U8YW55PiB7XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2U8YW55PihyZXNvbHZlID0+IHtcclxuICAgICAgcmVzb2x2ZShcclxuICAgICAgICBKU09OLnBhcnNlKFxyXG4gICAgICAgICAgdGhpcy5jb21waWxlci5xdWVyeShcclxuICAgICAgICAgICAgb3B0aW9ucy5tYWluRmlsZVBhdGgsXHJcbiAgICAgICAgICAgIGNvbnZlcnRJbnB1dHMob3B0aW9ucy5pbnB1dHMpLFxyXG4gICAgICAgICAgICBvcHRpb25zLnNlbGVjdG9yLFxyXG4gICAgICAgICAgICBvcHRpb25zLmZpZWxkLFxyXG4gICAgICAgICAgKSxcclxuICAgICAgICApLFxyXG4gICAgICApO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBnZXRTZW1hbnRpY1Rva2VuTGVnZW5kKCk6IFByb21pc2U8U2VtYW50aWNUb2tlbnNMZWdlbmQ+IHtcclxuICAgIHJldHVybiBuZXcgUHJvbWlzZTxTZW1hbnRpY1Rva2Vuc0xlZ2VuZD4ocmVzb2x2ZSA9PiB7XHJcbiAgICAgIHJlc29sdmUodGhpcy5jb21waWxlci5nZXRfc2VtYW50aWNfdG9rZW5fbGVnZW5kKCkpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBnZXRTZW1hbnRpY1Rva2VucyhvcHRzOiB7XHJcbiAgICBtYWluRmlsZVBhdGg6IHN0cmluZztcclxuICAgIHJlc3VsdElkPzogc3RyaW5nO1xyXG4gICAgb2Zmc2V0RW5jb2Rpbmc/OiBzdHJpbmc7XHJcbiAgfSk6IFByb21pc2U8U2VtYW50aWNUb2tlbnM+IHtcclxuICAgIHJldHVybiBuZXcgUHJvbWlzZTxTZW1hbnRpY1Rva2Vucz4ocmVzb2x2ZSA9PiB7XHJcbiAgICAgIHRoaXMuY29tcGlsZXIucmVzZXQoKTtcclxuICAgICAgcmVzb2x2ZShcclxuICAgICAgICB0aGlzLmNvbXBpbGVyLmdldF9zZW1hbnRpY190b2tlbnMoXHJcbiAgICAgICAgICBvcHRzLm9mZnNldEVuY29kaW5nIHx8ICd1dGYtMTYnLFxyXG4gICAgICAgICAgb3B0cy5tYWluRmlsZVBhdGgsXHJcbiAgICAgICAgICBvcHRzLnJlc3VsdElkLFxyXG4gICAgICAgICkgYXMgYW55LFxyXG4gICAgICApO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBhc3luYyB3aXRoSW5jcmVtZW50YWxTZXJ2ZXI8VD4oZjogKHM6IEluY3JlbWVudGFsU2VydmVyKSA9PiBQcm9taXNlPFQ+KTogUHJvbWlzZTxUPiB7XHJcbiAgICBjb25zdCBzcnYgPSBuZXcgSW5jcmVtZW50YWxTZXJ2ZXIodGhpcy5jb21waWxlci5jcmVhdGVfaW5jcl9zZXJ2ZXIoKSk7XHJcbiAgICB0cnkge1xyXG4gICAgICByZXR1cm4gYXdhaXQgZihzcnYpO1xyXG4gICAgfSBmaW5hbGx5IHtcclxuICAgICAgc3J2W2tPYmplY3RdLmZyZWUoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGFzeW5jIGdldEFzdChtYWluRmlsZVBhdGg6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nPiB7XHJcbiAgICByZXR1cm4gdGhpcy5jb21waWxlci5nZXRfYXN0KG1haW5GaWxlUGF0aCk7XHJcbiAgfVxyXG5cclxuICBhc3luYyByZXNldCgpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIGF3YWl0IG5ldyBQcm9taXNlPHZvaWQ+KHJlc29sdmUgPT4ge1xyXG4gICAgICB0aGlzLmNvbXBpbGVyLnJlc2V0KCk7XHJcbiAgICAgIHJlc29sdmUodW5kZWZpbmVkKTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgYWRkU291cmNlKHBhdGg6IHN0cmluZywgc291cmNlOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID4gMikge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXHJcbiAgICAgICAgJ3VzZSBvZiBhZGRTb3VyY2UocGF0aCwgc291cmNlLCBpc01haW4pIGlzIGRlcHJlY2F0ZWQsIHBsZWFzZSB1c2UgYWRkU291cmNlKHBhdGgsIHNvdXJjZSkgaW5zdGVhZCcsXHJcbiAgICAgICk7XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5jb21waWxlci5hZGRfc291cmNlKHBhdGgsIHNvdXJjZSk7XHJcbiAgfVxyXG5cclxuICBtYXBTaGFkb3cocGF0aDogc3RyaW5nLCBjb250ZW50OiBVaW50OEFycmF5KTogdm9pZCB7XHJcbiAgICB0aGlzLmNvbXBpbGVyLm1hcF9zaGFkb3cocGF0aCwgY29udGVudCk7XHJcbiAgfVxyXG5cclxuICB1bm1hcFNoYWRvdyhwYXRoOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIHRoaXMuY29tcGlsZXIudW5tYXBfc2hhZG93KHBhdGgpO1xyXG4gIH1cclxuXHJcbiAgcmVzZXRTaGFkb3coKTogdm9pZCB7XHJcbiAgICB0aGlzLmNvbXBpbGVyLnJlc2V0X3NoYWRvdygpO1xyXG4gIH1cclxuXHJcbiAgcmVuZGVyUGFnZVRvQ2FudmFzKCk6IFByb21pc2U8YW55PiB7XHJcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ1BsZWFzZSB1c2UgdGhlIGFwaSBUeXBzdFJlbmRlcmVyLnJlbmRlclRvQ2FudmFzIGluIHYwLjQuMCcpO1xyXG4gIH1cclxufVxyXG5jcmVhdGVUeXBzdENvbXBpbGVyLl9pbXBsID0gVHlwc3RDb21waWxlckRyaXZlcjtcclxuXHJcbi8vIHRvZG86IGNhY2hpbmcgaW5wdXRzXHJcbmZ1bmN0aW9uIGNvbnZlcnRJbnB1dHMoaW5wdXRzPzogUmVjb3JkPHN0cmluZywgc3RyaW5nPik6IFtzdHJpbmcsIHN0cmluZ11bXSB8IHVuZGVmaW5lZCB7XHJcbiAgcmV0dXJuIGlucHV0cyA/IE9iamVjdC5lbnRyaWVzKGlucHV0cykgOiB1bmRlZmluZWQ7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGdldERpYWdub3N0aWNzQXJnKGRpYWdub3N0aWNzOiBzdHJpbmcgfCB1bmRlZmluZWQpOiBudW1iZXIge1xyXG4gIHN3aXRjaCAoZGlhZ25vc3RpY3MpIHtcclxuICAgIGNhc2UgJ25vbmUnOlxyXG4gICAgICByZXR1cm4gMTtcclxuICAgIGNhc2UgJ3VuaXgnOlxyXG4gICAgICByZXR1cm4gMjtcclxuICAgIGNhc2UgJ2Z1bGwnOlxyXG4gICAgZGVmYXVsdDpcclxuICAgICAgcmV0dXJuIDM7XHJcbiAgfVxyXG59XHJcbiJdfQ==