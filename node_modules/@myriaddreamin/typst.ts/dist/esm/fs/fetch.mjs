export class FetchAccessModel {
    root;
    fullyCached;
    mTimes = new Map();
    mRealPaths = new Map();
    mData = new Map();
    constructor(root, options) {
        this.root = root;
        if (root.endsWith('/')) {
            this.root = this.root.slice(0, this.root.length - 1);
        }
        if (options?.polyfillHeadRequest) {
            void 0;
        }
        this.fullyCached = !!options?.fullyCached;
    }
    reset() {
        this.mTimes.clear();
        this.mRealPaths.clear();
        this.mData.clear();
    }
    resolvePath(path) {
        return this.root + path;
    }
    insertFile(path, data, mtime) {
        this.mTimes.set(path, mtime);
        this.mData.set(path, data);
    }
    removeFile(path) {
        this.mTimes.delete(path);
        this.mData.delete(path);
    }
    async getPreloadScript() {
        const snapshot = [];
        snapshot.push('((async () => {');
        snapshot.push(`const snapshot = {  root: '', mTimes: new Map(),  mRealPaths: new Map(),  mData: [],};`);
        // runFetch
        snapshot.push(`const runFetch = async (path) => {`);
        snapshot.push(`  const res = await fetch(snapshot.root + path);`);
        snapshot.push(`  const buffer = await res.arrayBuffer();`);
        snapshot.push(`  return [path, new Uint8Array(buffer)];`);
        snapshot.push(`};`);
        snapshot.push(`snapshot.root = ${JSON.stringify(this.root)};`);
        snapshot.push(`snapshot.mTimes = new Map([${[...this.mTimes.entries()]
            .map(([k, v]) => `[${JSON.stringify(k)}, ${v?.getTime() || 'undefined'}]`)
            .join(', ')}]);`);
        snapshot.push(`snapshot.mRealPaths = new Map([${[...this.mRealPaths.entries()]
            .map(([k, v]) => `[${JSON.stringify(k)}, ${JSON.stringify(v)}]`)
            .join(', ')}]);`);
        const dataEntries = await Promise.all([...this.mData.entries()].map(async ([k, v]) => {
            k = JSON.stringify(k);
            return v ? `runFetch(${k})` : `Promise.resolve([${k}, undefined])`;
        }));
        snapshot.push(`snapshot.mData = await Promise.all([${dataEntries.join(', ')}]);`);
        snapshot.push(`return snapshot;`);
        snapshot.push('})())');
        return snapshot.join('\n');
    }
    getLastModified(path) {
        const request = new XMLHttpRequest();
        request.open('HEAD', path, false);
        request.send(null);
        if (request.status === 200) {
            return request.getResponseHeader('Last-Modified');
        }
        return null;
    }
    getMTimeInternal(path) {
        const lastModified = this.getLastModified(this.resolvePath(path));
        if (lastModified) {
            return new Date(lastModified);
        }
        return undefined;
    }
    getMTime(path) {
        // todo: no hack
        if (path.startsWith('/@memory/')) {
            if (this.mTimes.has(path)) {
                return this.mTimes.get(path);
            }
            return undefined;
        }
        if (!this.fullyCached) {
            return this.getMTimeInternal(path);
        }
        if (this.mTimes.has(path)) {
            return this.mTimes.get(path);
        }
        const mTime = this.getMTimeInternal(path);
        this.mTimes.set(path, mTime);
        return mTime;
    }
    // todo: isFile
    isFile() {
        // path: string
        // const request = this.getLastModified(this.resolvePath(path));
        // if (request.status === 200) {
        //   console.log(request, request.getAllResponseHeaders());
        // }
        return true;
    }
    // todo: getRealPath
    getRealPath(path) {
        return path;
    }
    readAllInternal(path) {
        const request = new XMLHttpRequest();
        request.overrideMimeType('text/plain; charset=x-user-defined');
        request.open('GET', this.resolvePath(path), false);
        request.send(null);
        if (request.status === 200 &&
            (request.response instanceof String || typeof request.response === 'string')) {
            return Uint8Array.from(request.response, (c) => c.charCodeAt(0));
        }
        return undefined;
    }
    readAll(path) {
        if (path.startsWith('/@memory/')) {
            if (this.mData.has(path)) {
                return this.mData.get(path);
            }
            return undefined;
        }
        if (!this.fullyCached) {
            return this.readAllInternal(path);
        }
        if (this.mData.has(path)) {
            return this.mData.get(path);
        }
        const data = this.readAllInternal(path);
        this.mData.set(path, data);
        return data;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmV0Y2gubWpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2ZzL2ZldGNoLm10cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFRQSxNQUFNLE9BQU8sZ0JBQWdCO0lBTWpCO0lBTFYsV0FBVyxDQUFVO0lBQ3JCLE1BQU0sR0FBa0MsSUFBSSxHQUFHLEVBQUUsQ0FBQztJQUNsRCxVQUFVLEdBQW9DLElBQUksR0FBRyxFQUFFLENBQUM7SUFDeEQsS0FBSyxHQUF3QyxJQUFJLEdBQUcsRUFBRSxDQUFDO0lBQ3ZELFlBQ1UsSUFBWSxFQUNwQixPQUE0QjtRQURwQixTQUFJLEdBQUosSUFBSSxDQUFRO1FBR3BCLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDO1lBQ3ZCLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQ3ZELENBQUM7UUFDRCxJQUFJLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxDQUFDO1lBQ2pDLEtBQUssQ0FBQyxDQUFDO1FBQ1QsQ0FBQztRQUNELElBQUksQ0FBQyxXQUFXLEdBQUcsQ0FBQyxDQUFDLE9BQU8sRUFBRSxXQUFXLENBQUM7SUFDNUMsQ0FBQztJQUVELEtBQUs7UUFDSCxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQ3BCLElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDeEIsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUNyQixDQUFDO0lBRUQsV0FBVyxDQUFDLElBQVk7UUFDdEIsT0FBTyxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztJQUMxQixDQUFDO0lBRUQsVUFBVSxDQUFDLElBQVksRUFBRSxJQUFnQixFQUFFLEtBQVc7UUFDcEQsSUFBSSxDQUFDLE1B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QUFDLFVBQVUsQ0FBQyxXQUFXLENBQUMsRUFBRSxDQUFDO1lBQ2pDLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQztnQkFDekIsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUM5QixDQUFDO1lBRUQsT0FBTyxTQUFTLENBQUM7UUFDbkIsQ0FBQztRQUVELElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7WUFDdEIsT0FBTyxJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3BDLENBQUM7UUFFRCxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUM7WUFDekIsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUM5QixDQUFDO1FBRUQsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN4QyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDM0IsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBGc0FjY2Vzc01vZGVsIH0gZnJvbSAnLi4vaW50ZXJuYWwudHlwZXMubWpzJztcclxuaW1wb3J0IHsgV3JpdGFibGVBY2Nlc3NNb2RlbCB9IGZyb20gJy4vaW5kZXgubWpzJztcclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgRmV0Y2hBY2Nlc3NPcHRpb25zIHtcclxuICBwb2x5ZmlsbEhlYWRSZXF1ZXN0PzogYm9vbGVhbjtcclxuICBmdWxseUNhY2hlZD86IGJvb2xlYW47XHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBGZXRjaEFjY2Vzc01vZGVsIGltcGxlbWVudHMgRnNBY2Nlc3NNb2RlbCwgV3JpdGFibGVBY2Nlc3NNb2RlbCB7XHJcbiAgZnVsbHlDYWNoZWQ6IGJvb2xlYW47XHJcbiAgbVRpbWVzOiBNYXA8c3RyaW5nLCBEYXRlIHwgdW5kZWZpbmVkPiA9IG5ldyBNYXAoKTtcclxuICBtUmVhbFBhdGhzOiBNYXA8c3RyaW5nLCBzdHJpbmcgfCB1bmRlZmluZWQ+ID0gbmV3IE1hcCgpO1xyXG4gIG1EYXRhOiBNYXA8c3RyaW5nLCBVaW50OEFycmF5IHwgdW5kZWZpbmVkPiA9IG5ldyBNYXAoKTtcclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHByaXZhdGUgcm9vdDogc3RyaW5nLFxyXG4gICAgb3B0aW9ucz86IEZldGNoQWNjZXNzT3B0aW9ucyxcclxuICApIHtcclxuICAgIGlmIChyb290LmVuZHNXaXRoKCcvJykpIHtcclxuICAgICAgdGhpcy5yb290ID0gdGhpcy5yb290LnNsaWNlKDAsIHRoaXMucm9vdC5sZW5ndGggLSAxKTtcclxuICAgIH1cclxuICAgIGlmIChvcHRpb25zPy5wb2x5ZmlsbEhlYWRSZXF1ZXN0KSB7XHJcbiAgICAgIHZvaWQgMDtcclxuICAgIH1cclxuICAgIHRoaXMuZnVsbHlDYWNoZWQgPSAhIW9wdGlvbnM/LmZ1bGx5Q2FjaGVkO1xyXG4gIH1cclxuXHJcbiAgcmVzZXQoKSB7XHJcbiAgICB0aGlzLm1UaW1lcy5jbGVhcigpO1xyXG4gICAgdGhpcy5tUmVhbFBhdGhzLmNsZWFyKCk7XHJcbiAgICB0aGlzLm1EYXRhLmNsZWFyKCk7XHJcbiAgfVxyXG5cclxuICByZXNvbHZlUGF0aChwYXRoOiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgcmV0dXJuIHRoaXMucm9vdCArIHBhdGg7XHJcbiAgfVxyXG5cclxuICBpbnNlcnRGaWxlKHBhdGg6IHN0cmluZywgZGF0YTogVWludDhBcnJheSwgbXRpbWU6IERhdGUpIHtcclxuICAgIHRoaXMubVRpbWVzLnNldChwYXRoLCBtdGltZSk7XHJcbiAgICB0aGlzLm1EYXRhLnNldChwYXRoLCBkYXRhKTtcclxuICB9XHJcblxyXG4gIHJlbW92ZUZpbGUocGF0aDogc3RyaW5nKSB7XHJcbiAgICB0aGlzLm1UaW1lcy5kZWxldGUocGF0aCk7XHJcbiAgICB0aGlzLm1EYXRhLmRlbGV0ZShwYXRoKTtcclxuICB9XHJcblxyXG4gIGFzeW5jIGdldFByZWxvYWRTY3JpcHQoKTogUHJvbWlzZTxzdHJpbmc+IHtcclxuICAgIGNvbnN0IHNuYXBzaG90OiBzdHJpbmdbXSA9IFtdO1xyXG5cclxuICAgIHNuYXBzaG90LnB1c2goJygoYXN5bmMgKCkgPT4geycpO1xyXG4gICAgc25hcHNob3QucHVzaChcclxuICAgICAgYGNvbnN0IHNuYXBzaG90ID0geyAgcm9vdDogJycsIG1UaW1lczogbmV3IE1hcCgpLCAgbVJlYWxQYXRoczogbmV3IE1hcCgpLCAgbURhdGE6IFtdLH07YCxcclxuICAgICk7XHJcbiAgICAvLyBydW5GZXRjaFxyXG4gICAgc25hcHNob3QucHVzaChgY29uc3QgcnVuRmV0Y2ggPSBhc3luYyAocGF0aCkgPT4ge2ApO1xyXG4gICAgc25hcHNob3QucHVzaChgICBjb25zdCByZXMgPSBhd2FpdCBmZXRjaChzbmFwc2hvdC5yb290ICsgcGF0aCk7YCk7XHJcbiAgICBzbmFwc2hvdC5wdXNoKGAgIGNvbnN0IGJ1ZmZlciA9IGF3YWl0IHJlcy5hcnJheUJ1ZmZlcigpO2ApO1xyXG4gICAgc25hcHNob3QucHVzaChgICByZXR1cm4gW3BhdGgsIG5ldyBVaW50OEFycmF5KGJ1ZmZlcildO2ApO1xyXG4gICAgc25hcHNob3QucHVzaChgfTtgKTtcclxuICAgIHNuYXBzaG90LnB1c2goYHNuYXBzaG90LnJvb3QgPSAke0pTT04uc3RyaW5naWZ5KHRoaXMucm9vdCl9O2ApO1xyXG4gICAgc25hcHNob3QucHVzaChcclxuICAgICAgYHNuYXBzaG90Lm1UaW1lcyA9IG5ldyBNYXAoWyR7Wy4uLnRoaXMubVRpbWVzLmVudHJpZXMoKV1cclxuICAgICAgICAubWFwKChbaywgdl0pID0+IGBbJHtKU09OLnN0cmluZ2lmeShrKX0sICR7dj8uZ2V0VGltZSgpIHx8ICd1bmRlZmluZWQnfV1gKVxyXG4gICAgICAgIC5qb2luKCcsICcpfV0pO2AsXHJcbiAgICApO1xyXG4gICAgc25hcHNob3QucHVzaChcclxuICAgICAgYHNuYXBzaG90Lm1SZWFsUGF0aHMgPSBuZXcgTWFwKFske1suLi50aGlzLm1SZWFsUGF0aHMuZW50cmllcygpXVxyXG4gICAgICAgIC5tYXAoKFtrLCB2XSkgPT4gYFske0pTT04uc3RyaW5naWZ5KGspfSwgJHtKU09OLnN0cmluZ2lmeSh2KX1dYClcclxuICAgICAgICAuam9pbignLCAnKX1dKTtgLFxyXG4gICAgKTtcclxuXHJcbiAgICBjb25zdCBkYXRhRW50cmllcyA9IGF3YWl0IFByb21pc2UuYWxsKFxyXG4gICAgICBbLi4udGhpcy5tRGF0YS5lbnRyaWVzKCldLm1hcChhc3luYyAoW2ssIHZdKSA9PiB7XHJcbiAgICAgICAgayA9IEpTT04uc3RyaW5naWZ5KGspO1xyXG4gICAgICAgIHJldHVybiB2ID8gYHJ1bkZldGNoKCR7a30pYCA6IGBQcm9taXNlLnJlc29sdmUoWyR7a30sIHVuZGVmaW5lZF0pYDtcclxuICAgICAgfSksXHJcbiAgICApO1xyXG4gICAgc25hcHNob3QucHVzaChgc25hcHNob3QubURhdGEgPSBhd2FpdCBQcm9taXNlLmFsbChbJHtkYXRhRW50cmllcy5qb2luKCcsICcpfV0pO2ApO1xyXG5cclxuICAgIHNuYXBzaG90LnB1c2goYHJldHVybiBzbmFwc2hvdDtgKTtcclxuICAgIHNuYXBzaG90LnB1c2goJ30pKCkpJyk7XHJcbiAgICByZXR1cm4gc25hcHNob3Quam9pbignXFxuJyk7XHJcbiAgfVxyXG5cclxuICBnZXRMYXN0TW9kaWZpZWQocGF0aDogc3RyaW5nKSB7XHJcbiAgICBjb25zdCByZXF1ZXN0ID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7XHJcbiAgICByZXF1ZXN0Lm9wZW4oJ0hFQUQnLCBwYXRoLCBmYWxzZSk7XHJcbiAgICByZXF1ZXN0LnNlbmQobnVsbCk7XHJcbiAgICBpZiAocmVxdWVzdC5zdGF0dXMgPT09IDIwMCkge1xyXG4gICAgICByZXR1cm4gcmVxdWVzdC5nZXRSZXNwb25zZUhlYWRlcignTGFzdC1Nb2RpZmllZCcpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIG51bGw7XHJcbiAgfVxyXG5cclxuICBnZXRNVGltZUludGVybmFsKHBhdGg6IHN0cmluZyk6IERhdGUgfCB1bmRlZmluZWQge1xyXG4gICAgY29uc3QgbGFzdE1vZGlmaWVkID0gdGhpcy5nZXRMYXN0TW9kaWZpZWQodGhpcy5yZXNvbHZlUGF0aChwYXRoKSk7XHJcbiAgICBpZiAobGFzdE1vZGlmaWVkKSB7XHJcbiAgICAgIHJldHVybiBuZXcgRGF0ZShsYXN0TW9kaWZpZWQpO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiB1bmRlZmluZWQ7XHJcbiAgfVxyXG5cclxuICBnZXRNVGltZShwYXRoOiBzdHJpbmcpOiBEYXRlIHwgdW5kZWZpbmVkIHtcclxuICAgIC8vIHRvZG86IG5vIGhhY2tcclxuICAgIGlmIChwYXRoLnN0YXJ0c1dpdGgoJy9AbWVtb3J5LycpKSB7XHJcbiAgICAgIGlmICh0aGlzLm1UaW1lcy5oYXMocGF0aCkpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5tVGltZXMuZ2V0KHBhdGgpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICghdGhpcy5mdWxseUNhY2hlZCkge1xyXG4gICAgICByZXR1cm4gdGhpcy5nZXRNVGltZUludGVybmFsKHBhdGgpO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICh0aGlzLm1UaW1lcy5oYXMocGF0aCkpIHtcclxuICAgICAgcmV0dXJuIHRoaXMubVRpbWVzLmdldChwYXRoKTtcclxuICAgIH1cclxuICAgIGNvbnN0IG1UaW1lID0gdGhpcy5nZXRNVGltZUludGVybmFsKHBhdGgpO1xyXG4gICAgdGhpcy5tVGltZXMuc2V0KHBhdGgsIG1UaW1lKTtcclxuICAgIHJldHVybiBtVGltZTtcclxuICB9XHJcblxyXG4gIC8vIHRvZG86IGlzRmlsZVxyXG4gIGlzRmlsZSgpOiBib29sZWFuIHwgdW5kZWZpbmVkIHtcclxuICAgIC8vIHBhdGg6IHN0cmluZ1xyXG4gICAgLy8gY29uc3QgcmVxdWVzdCA9IHRoaXMuZ2V0TGFzdE1vZGlmaWVkKHRoaXMucmVzb2x2ZVBhdGgocGF0aCkpO1xyXG4gICAgLy8gaWYgKHJlcXVlc3Quc3RhdHVzID09PSAyMDApIHtcclxuICAgIC8vICAgY29uc29sZS5sb2cocmVxdWVzdCwgcmVxdWVzdC5nZXRBbGxSZXNwb25zZUhlYWRlcnMoKSk7XHJcbiAgICAvLyB9XHJcbiAgICByZXR1cm4gdHJ1ZTtcclxuICB9XHJcblxyXG4gIC8vIHRvZG86IGdldFJlYWxQYXRoXHJcbiAgZ2V0UmVhbFBhdGgocGF0aDogc3RyaW5nKTogc3RyaW5nIHwgdW5kZWZpbmVkIHtcclxuICAgIHJldHVybiBwYXRoO1xyXG4gIH1cclxuXHJcbiAgcmVhZEFsbEludGVybmFsKHBhdGg6IHN0cmluZyk6IFVpbnQ4QXJyYXkgfCB1bmRlZmluZWQge1xyXG4gICAgY29uc3QgcmVxdWVzdCA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpO1xyXG4gICAgcmVxdWVzdC5vdmVycmlkZU1pbWVUeXBlKCd0ZXh0L3BsYWluOyBjaGFyc2V0PXgtdXNlci1kZWZpbmVkJyk7XHJcbiAgICByZXF1ZXN0Lm9wZW4oJ0dFVCcsIHRoaXMucmVzb2x2ZVBhdGgocGF0aCksIGZhbHNlKTtcclxuICAgIHJlcXVlc3Quc2VuZChudWxsKTtcclxuXHJcbiAgICBpZiAoXHJcbiAgICAgIHJlcXVlc3Quc3RhdHVzID09PSAyMDAgJiZcclxuICAgICAgKHJlcXVlc3QucmVzcG9uc2UgaW5zdGFuY2VvZiBTdHJpbmcgfHwgdHlwZW9mIHJlcXVlc3QucmVzcG9uc2UgPT09ICdzdHJpbmcnKVxyXG4gICAgKSB7XHJcbiAgICAgIHJldHVybiBVaW50OEFycmF5LmZyb20ocmVxdWVzdC5yZXNwb25zZSwgKGM6IHN0cmluZykgPT4gYy5jaGFyQ29kZUF0KDApKTtcclxuICAgIH1cclxuICAgIHJldHVybiB1bmRlZmluZWQ7XHJcbiAgfVxyXG5cclxuICByZWFkQWxsKHBhdGg6IHN0cmluZyk6IFVpbnQ4QXJyYXkgfCB1bmRlZmluZWQge1xyXG4gICAgaWYgKHBhdGguc3RhcnRzV2l0aCgnL0BtZW1vcnkvJykpIHtcclxuICAgICAgaWYgKHRoaXMubURhdGEuaGFzKHBhdGgpKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMubURhdGEuZ2V0KHBhdGgpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICghdGhpcy5mdWxseUNhY2hlZCkge1xyXG4gICAgICByZXR1cm4gdGhpcy5yZWFkQWxsSW50ZXJuYWwocGF0aCk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHRoaXMubURhdGEuaGFzKHBhdGgpKSB7XHJcbiAgICAgIHJldHVybiB0aGlzLm1EYXRhLmdldChwYXRoKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBkYXRhID0gdGhpcy5yZWFkQWxsSW50ZXJuYWwocGF0aCk7XHJcbiAgICB0aGlzLm1EYXRhLnNldChwYXRoLCBkYXRhKTtcclxuICAgIHJldHVybiBkYXRhO1xyXG4gIH1cclxufVxyXG4iXX0=