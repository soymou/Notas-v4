export var PreviewMode;
(function (PreviewMode) {
    PreviewMode[PreviewMode["Doc"] = 0] = "Doc";
    PreviewMode[PreviewMode["Slide"] = 1] = "Slide";
})(PreviewMode || (PreviewMode = {}));
export class TypstDocumentContext {
    hookedElem;
    kModule;
    opts;
    modes = [];
    /// Configuration fields
    /// enable partial rendering
    partialRendering = true;
    /// underlying renderer
    renderMode = 'svg';
    r = undefined;
    /// preview mode
    previewMode = PreviewMode.Doc;
    /// whether this is a content preview
    isContentPreview = false;
    /// whether this content preview will mix outline titles
    isMixinOutline = false;
    /// background color
    backgroundColor = 'black';
    /// default page color (empty string means transparent)
    pageColor = 'white';
    /// pixel per pt
    pixelPerPt = 3;
    /// customized way to retrieving dom state
    retrieveDOMState;
    /// State fields
    /// whether svg is updating (in triggerSvgUpdate)
    isRendering = false;
    /// whether kModule is initialized
    moduleInitialized = false;
    /// patch queue for updating data.
    patchQueue = [];
    /// resources to dispose
    disposeList = [];
    /// canvas render ctoken
    canvasRenderCToken;
    /// There are two scales in this class: The real scale is to adjust the size
    /// of `hookedElem` to fit the svg. The virtual scale (scale ratio) is to let
    /// user zoom in/out the svg. For example:
    /// + the default value of virtual scale is 1, which means the svg is totally
    ///   fit in `hookedElem`.
    /// + if user set virtual scale to 0.5, then the svg will be zoomed out to fit
    ///   in half width of `hookedElem`. "real" current scale of `hookedElem`
    currentRealScale = 1;
    /// "virtual" current scale of `hookedElem`
    currentScaleRatio = 1;
    /// timeout for delayed viewport change
    vpTimeout = undefined;
    /// sampled by last render time.
    sampledRenderTime = 0;
    /// page to partial render
    partialRenderPage = 0;
    /// outline data
    outline = undefined;
    /// cursor position in form of [page, x, y]
    cursorPosition = undefined;
    // id: number = rnd++;
    /// Cache fields
    /// cached state of container, default to retrieve state from `this.hookedElem`
    cachedDOMState = {
        width: 0,
        height: 0,
        window: {
            innerWidth: 0,
            innerHeight: 0,
        },
        boundingRect: {
            left: 0,
            top: 0,
            right: 0,
        },
    };
    constructor(opts) {
        this.hookedElem = opts.hookedElem;
        this.kModule = opts.kModule;
        this.opts = opts || {};
        /// Apply configuration
        {
            const { renderMode, previewMode, isContentPreview, retrieveDOMState } = opts || {};
            this.partialRendering = false;
            this.renderMode = renderMode ?? this.renderMode;
            this.previewMode = previewMode ?? this.previewMode;
            this.isContentPreview = isContentPreview || false;
            this.retrieveDOMState =
                retrieveDOMState ??
                    (() => {
                        return {
                            width: this.hookedElem.offsetWidth,
                            height: this.hookedElem.offsetHeight,
                            window: {
                                innerWidth: window.innerWidth,
                                innerHeight: window.innerHeight,
                            },
                            boundingRect: this.hookedElem.getBoundingClientRect(),
                        };
                    });
            this.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--typst-preview-background-color');
        }
        // if init scale == 1
        // hide scrollbar if scale == 1
        this.hookedElem.classList.add('hide-scrollbar-x');
        this.hookedElem.parentElement?.classList.add('hide-scrollbar-x');
        if (this.previewMode === PreviewMode.Slide) {
            this.hookedElem.classList.add('hide-scrollbar-y');
            this.hookedElem.parentElement?.classList.add('hide-scrollbar-y');
        }
        this.installCtrlWheelHandler();
    }
    reset() {
        this.kModule.reset();
        this.moduleInitialized = false;
    }
    dispose() {
        const disposeList = this.disposeList;
        this.disposeList = [];
        disposeList.forEach(x => x());
    }
    static derive(ctx, mode) {
        return ['rescale', 'rerender', 'postRender'].reduce((acc, x) => {
            acc[x] = ctx[`${x}$${mode}`].bind(ctx);
            console.assert(acc[x] !== undefined, `${x}$${mode} is undefined`);
            return acc;
        }, {});
    }
    registerMode(mode) {
        const facade = TypstDocumentContext.derive(this, mode);
        this.modes.push([mode, facade]);
        if (mode === this.renderMode) {
            this.r = facade;
        }
    }
    installCtrlWheelHandler() {
        // Ctrl+scroll rescaling
        // will disable auto resizing
        // fixed factors, same as pdf.js
        const factors = [
            0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1, 1.1, 1.3, 1.5, 1.7, 1.9, 2.1, 2.4, 2.7, 3,
            3.3, 3.7, 4.1, 4.6, 5.1, 5.7, 6.3, 7, 7.7, 8.5, 9.4, 10,
        ];
        const wheelEventHandler = (event) => {
            if (event.ctrlKey) {
                event.preventDefault();
                // retrieve dom state before any operation
                this.cachedDOMState = this.retrieveDOMState();
                if (window.onresize !== null) {
                    // is auto resizing
                    window.onresize = null;
                }
                const prevScaleRatio = this.currentScaleRatio;
                // Get wheel scroll direction and calculate new scale
                if (event.deltaY < 0) {
                    // enlarge
                    if (this.currentScaleRatio >= factors.at(-1)) {
                        // already large than max factor
                        return;
                    }
                    else {
                        this.currentScaleRatio = factors.filter(x => x > this.currentScaleRatio).at(0);
                    }
                }
                else if (event.deltaY > 0) {
                    // reduce
                    if (this.currentScaleRatio <= factors.at(0)) {
                        return;
                    }
                    else {
                        this.currentScaleRatio = factors.filter(x => x < this.currentScaleRatio).at(-1);
                    }
                }
                else {
                    // no y-axis scroll
                    return;
                }
                const scrollFactor = this.currentScaleRatio / prevScaleRatio;
                const scrollX = event.pageX * (scrollFactor - 1);
                const scrollY = event.pageY * (scrollFactor - 1);
                // hide scrollbar if scale == 1
                if (Math.abs(this.currentScaleRatio - 1) < 1e-5) {
                    this.hookedElem.classList.add('hide-scrollbar-x');
                    this.hookedElem.parentElement?.classList.add('hide-scrollbar-x');
                    if (this.previewMode === PreviewMode.Slide) {
                        this.hookedElem.classList.add('hide-scrollbar-y');
                        this.hookedElem.parentElement?.classList.add('hide-scrollbar-y');
                    }
                }
                else {
                    this.hookedElem.classList.remove('hide-scrollbar-x');
                    this.hookedElem.parentElement?.classList.remove('hide-scrollbar-x');
                    if (this.previewMode === PreviewMode.Slide) {
                        this.hookedElem.classList.remove('hide-scrollbar-y');
                        this.hookedElem.parentElement?.classList.remove('hide-scrollbar-y');
                    }
                }
                // reserve space to scroll down
                const svg = this.hookedElem.firstElementChild;
                if (svg) {
                    const scaleRatio = this.getSvgScaleRatio();
                    const dataHeight = Number.parseFloat(svg.getAttribute('data-height'));
                    const scaledHeight = Math.ceil(dataHeight * scaleRatio);
                    // we increase the height by 2 times.
                    // The `2` is only a magic number that is large enough.
                    this.hookedElem.style.height = `${scaledHeight * 2}px`;
                }
                // make sure the cursor is still on the same position
                window.scrollBy(scrollX, scrollY);
                // toggle scale change event
                this.addViewportChange();
                return false;
            }
        };
        if (this.renderMode !== 'dom') {
            const vscodeAPI = typeof acquireVsCodeApi !== 'undefined';
            if (vscodeAPI) {
                window.addEventListener('wheel', wheelEventHandler, {
                    passive: false,
                });
                this.disposeList.push(() => {
                    window.removeEventListener('wheel', wheelEventHandler);
                });
            }
            else {
                document.body.addEventListener('wheel', wheelEventHandler, {
                    passive: false,
                });
                this.disposeList.push(() => {
                    document.body.removeEventListener('wheel', wheelEventHandler);
                });
            }
        }
    }
    /// Get current scale from html to svg
    // Note: one should retrieve dom state before rescale
    getSvgScaleRatio() {
        const svg = this.hookedElem.firstElementChild;
        if (!svg) {
            return 0;
        }
        const container = this.cachedDOMState;
        const svgWidth = Number.parseFloat(svg.getAttribute('data-width') || svg.getAttribute('width') || '1');
        const svgHeight = Number.parseFloat(svg.getAttribute('data-height') || svg.getAttribute('height') || '1');
        this.currentRealScale =
            this.previewMode === PreviewMode.Slide
                ? Math.min(container.width / svgWidth, container.height / svgHeight)
                : container.width / svgWidth;
        return this.currentRealScale * this.currentScaleRatio;
    }
    processQueue(svgUpdateEvent) {
        const eventName = svgUpdateEvent[0];
        switch (eventName) {
            case 'new':
            case 'diff-v1': {
                if (eventName === 'new') {
                    this.reset();
                }
                this.kModule.manipulateData({
                    action: 'merge',
                    data: svgUpdateEvent[1],
                });
                this.moduleInitialized = true;
                return true;
            }
            case 'viewport-change': {
                if (!this.moduleInitialized) {
                    console.log('viewport-change before initialization');
                    return false;
                }
                return true;
            }
            default:
                console.log('svgUpdateEvent', svgUpdateEvent);
                return false;
        }
    }
    triggerUpdate() {
        if (this.isRendering) {
            return;
        }
        this.isRendering = true;
        const doUpdate = async () => {
            this.cachedDOMState = this.retrieveDOMState();
            if (this.patchQueue.length === 0) {
                this.isRendering = false;
                this.postprocessChanges();
                return;
            }
            try {
                let t0 = performance.now();
                const ctoken = this.canvasRenderCToken;
                if (ctoken) {
                    await ctoken.cancel();
                    await ctoken.wait();
                    this.canvasRenderCToken = undefined;
                    console.log('cancel canvas rendering');
                }
                let needRerender = false;
                // console.log('patchQueue', JSON.stringify(this.patchQueue.map(x => x[0])));
                while (this.patchQueue.length > 0) {
                    needRerender = this.processQueue(this.patchQueue.shift()) || needRerender;
                }
                // todo: trigger viewport change once
                let t1 = performance.now();
                if (needRerender) {
                    this.r.rescale();
                    await this.r.rerender();
                    this.r.rescale();
                }
                let t2 = performance.now();
                /// perf event
                const d = (e, x, y) => `${e} ${(y - x).toFixed(2)} ms`;
                this.sampledRenderTime = t2 - t0;
                console.log([d('parse', t0, t1), d('rerender', t1, t2), d('total', t0, t2)].join(', '));
                requestAnimationFrame(doUpdate);
            }
            catch (e) {
                console.error(e);
                this.isRendering = false;
                this.postprocessChanges();
            }
        };
        requestAnimationFrame(doUpdate);
    }
    postprocessChanges() {
        this.r.postRender();
        // todo: abstract this
        if (this.previewMode === PreviewMode.Slide) {
            document.querySelectorAll('.typst-page-number-indicator').forEach(x => {
                x.textContent = `${this.kModule.retrievePagesInfo().length}`;
            });
        }
    }
    addChangement(change) {
        if (change[0] === 'new') {
            this.patchQueue.splice(0, this.patchQueue.length);
        }
        const pushChange = () => {
            this.vpTimeout = undefined;
            this.patchQueue.push(change);
            this.triggerUpdate();
        };
        if (this.vpTimeout !== undefined) {
            clearTimeout(this.vpTimeout);
        }
        if (change[0] === 'viewport-change' && this.isRendering) {
            // delay viewport change a bit
            this.vpTimeout = setTimeout(pushChange, this.sampledRenderTime || 100);
        }
        else {
            pushChange();
        }
    }
    addViewportChange() {
        this.addChangement(['viewport-change', '']);
    }
}
export function provideDoc(Base) {
    return class TypstDocument {
        impl;
        kModule;
        constructor(options) {
            if (options.isContentPreview) {
                options.renderMode = 'canvas';
            }
            this.kModule = options.kModule;
            this.impl = new Base(options);
            if (!this.impl.r) {
                throw new Error(`mode is not supported, ${options?.renderMode}`);
            }
            if (options.isContentPreview) {
                // content preview has very bad performance without partial rendering
                this.impl.partialRendering = true;
                this.impl.pixelPerPt = 1;
                this.impl.isMixinOutline = true;
            }
        }
        dispose() {
            this.impl.dispose();
        }
        reset() {
            this.impl.reset();
        }
        addChangement(change) {
            this.impl.addChangement(change);
        }
        addViewportChange() {
            this.impl.addViewportChange();
        }
        setPageColor(color) {
            this.impl.pageColor = color;
            this.addViewportChange();
        }
        setPartialRendering(partialRendering) {
            this.impl.partialRendering = partialRendering;
        }
        setCursor(page, x, y) {
            this.impl.cursorPosition = [page, x, y];
        }
        setPartialPageNumber(page) {
            if (page <= 0 || page > this.kModule.retrievePagesInfo().length) {
                return false;
            }
            this.impl.partialRenderPage = page - 1;
            this.addViewportChange();
            return true;
        }
        getPartialPageNumber() {
            return this.impl.partialRenderPage + 1;
        }
        setOutineData(outline) {
            this.impl.outline = outline;
            this.addViewportChange();
        }
    };
}
export function composeDoc(Base, ...mixins) {
    return mixins.reduce((acc, mixin) => mixin(acc), Base);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHlwc3QtZG9jLm1qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb250cmliL2RvbS90eXBzdC1kb2MubXRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQXVCQSxNQUFNLENBQU4sSUFBWSxXQUdYO0FBSEQsV0FBWSxXQUFXO0lBQ3JCLDJDQUFHLENBQUE7SUFDSCwrQ0FBSyxDQUFBO0FBQ1AsQ0FBQyxFQUhXLFdBQVcsS0FBWCxXQUFXLFFBR3RCO0FBb0JELE1BQU0sT0FBTyxvQkFBb0I7SUFDeEIsVUFBVSxDQUFjO0lBQ3hCLE9BQU8sQ0FBZ0I7SUFDdkIsSUFBSSxDQUFJO0lBQ2YsS0FBSyxHQUFvQyxFQUFFLENBQUM7SUFFNUMsd0JBQXdCO0lBRXhCLDRCQUE0QjtJQUM1QixnQkFBZ0IsR0FBWSxJQUFJLENBQUM7SUFDakMsdUJBQXVCO0lBQ3ZCLFVBQVUsR0FBZSxLQUFLLENBQUM7SUFDL0IsQ0FBQyxHQUF3QixTQUFVLENBQUM7SUFDcEMsZ0JBQWdCO0lBQ2hCLFdBQVcsR0FBZ0IsV0FBVyxDQUFDLEdBQUcsQ0FBQztJQUMzQyxxQ0FBcUM7SUFDckMsZ0JBQWdCLEdBQVksS0FBSyxDQUFDO0lBQ2xDLHdEQUF3RDtJQUN4RCxjQUFjLEdBQVksS0FBSyxDQUFDO0lBQ2hDLG9CQUFvQjtJQUNwQixlQUFlLEdBQVcsT0FBTyxDQUFDO0lBQ2xDLHVEQUF1RDtJQUN2RCxTQUFTLEdBQVcsT0FBTyxDQUFDO0lBQzVCLGdCQUFnQjtJQUNoQixVQUFVLEdBQVcsQ0FBQyxDQUFDO0lBQ3ZCLDBDQUEwQztJQUMxQyxnQkFBZ0IsQ0FBMEI7SUFFMUMsZ0JBQWdCO0lBRWhCLGlEQUFpRDtJQUNqRCxXQUFXLEdBQVksS0FBSyxDQUFDO0lBQzdCLGtDQUFrQztJQUNsQyxpQkFBaUIsR0FBWSxLQUFLLENBQUM7SUFDbkMsa0NBQWtDO0lBQ2xDLFVBQVUsR0FBdUIsRUFBRSxDQUFDO0lBQ3BDLHdCQUF3QjtJQUN4QixXQUFXLEdBQW1C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ekQsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB0eXBlIHsgUmVuZGVyU2Vzc2lvbiB9IGZyb20gJy4uLy4uL3JlbmRlcmVyLm1qcyc7XHJcbmltcG9ydCB7IFR5cHN0Q2FuY2VsbGF0aW9uVG9rZW4gfSBmcm9tICcuL3R5cHN0LWNhbmNlbC5tanMnO1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBDb250YWluZXJET01TdGF0ZSB7XHJcbiAgLy8vIGNhY2hlZCBgaG9va2VkRWxlbS5vZmZzZXRXaWR0aGAgb3IgYGhvb2tlZEVsZW0uaW5uZXJXaWR0aGBcclxuICB3aWR0aDogbnVtYmVyO1xyXG4gIC8vLyBjYWNoZWQgYGhvb2tlZEVsZW0ub2Zmc2V0SGVpZ2h0YCBvciBgaG9va2VkRWxlbS5pbm5lckhlaWdodGBcclxuICBoZWlnaHQ6IG51bWJlcjtcclxuICB3aW5kb3c6IHtcclxuICAgIGlubmVyV2lkdGg6IG51bWJlcjtcclxuICAgIGlubmVySGVpZ2h0OiBudW1iZXI7XHJcbiAgfTtcclxuICAvLy8gY2FjaGVkIGBob29rZWRFbGVtLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpYFxyXG4gIC8vLyBXZSBvbmx5IHVzZSBgbGVmdGAgYW5kIGB0b3BgIGhlcmUuXHJcbiAgYm91bmRpbmdSZWN0OiB7XHJcbiAgICBsZWZ0OiBudW1iZXI7XHJcbiAgICB0b3A6IG51bWJlcjtcclxuICAgIHJpZ2h0OiBudW1iZXI7XHJcbiAgfTtcclxufVxyXG5cclxuZXhwb3J0IHR5cGUgUmVuZGVyTW9kZSA9ICdzdmcnIHwgJ2NhbnZhcycgfCAnZG9tJztcclxuXHJcbmV4cG9ydCBlbnVtIFByZXZpZXdNb2RlIHtcclxuICBEb2MsXHJcbiAgU2xpZGUsXHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgT3B0aW9ucyB7XHJcbiAgaG9va2VkRWxlbTogSFRNTEVsZW1lbnQ7XHJcbiAga01vZHVsZTogUmVuZGVyU2Vzc2lvbjtcclxuICByZW5kZXJNb2RlPzogUmVuZGVyTW9kZTtcclxuICBwcmV2aWV3TW9kZT86IFByZXZpZXdNb2RlO1xyXG4gIGlzQ29udGVudFByZXZpZXc/OiBib29sZWFuO1xyXG4gIHNvdXJjZU1hcHBpbmc/OiBib29sZWFuO1xyXG4gIHJldHJpZXZlRE9NU3RhdGU/OiAoKSA9PiBDb250YWluZXJET01TdGF0ZTtcclxufVxyXG5cclxuZXhwb3J0IHR5cGUgR0NvbnN0cnVjdG9yPFQgPSB7fT4gPSBuZXcgKC4uLmFyZ3M6IGFueVtdKSA9PiBUO1xyXG5cclxuaW50ZXJmYWNlIFR5cHN0RG9jdW1lbnRGYWNhZGUge1xyXG4gIHJlc2NhbGUoKTogdm9pZDtcclxuICByZXJlbmRlcigpOiBQcm9taXNlPHZvaWQ+O1xyXG4gIHBvc3RSZW5kZXIoKTogdm9pZDtcclxufVxyXG5cclxuZXhwb3J0IGNsYXNzIFR5cHN0RG9jdW1lbnRDb250ZXh0PE8gPSBhbnk+IHtcclxuICBwdWJsaWMgaG9va2VkRWxlbTogSFRNTEVsZW1lbnQ7XHJcbiAgcHVibGljIGtNb2R1bGU6IFJlbmRlclNlc3Npb247XHJcbiAgcHVibGljIG9wdHM6IE87XHJcbiAgbW9kZXM6IFtzdHJpbmcsIFR5cHN0RG9jdW1lbnRGYWNhZGVdW10gPSBbXTtcclxuXHJcbiAgLy8vIENvbmZpZ3VyYXRpb24gZmllbGRzXHJcblxyXG4gIC8vLyBlbmFibGUgcGFydGlhbCByZW5kZXJpbmdcclxuICBwYXJ0aWFsUmVuZGVyaW5nOiBib29sZWFuID0gdHJ1ZTtcclxuICAvLy8gdW5kZXJseWluZyByZW5kZXJlclxyXG4gIHJlbmRlck1vZGU6IFJlbmRlck1vZGUgPSAnc3ZnJztcclxuICByOiBUeXBzdERvY3VtZW50RmFjYWRlID0gdW5kZWZpbmVkITtcclxuICAvLy8gcHJldmlldyBtb2RlXHJcbiAgcHJldmlld01vZGU6IFByZXZpZXdNb2RlID0gUHJldmlld01vZGUuRG9jO1xyXG4gIC8vLyB3aGV0aGVyIHRoaXMgaXMgYSBjb250ZW50IHByZXZpZXdcclxuICBpc0NvbnRlbnRQcmV2aWV3OiBib29sZWFuID0gZmFsc2U7XHJcbiAgLy8vIHdoZXRoZXIgdGhpcyBjb250ZW50IHByZXZpZXcgd2lsbCBtaXggb3V0bGluZSB0aXRsZXNcclxuICBpc01peGluT3V0bGluZTogYm9vbGVhbiA9IGZhbHNlO1xyXG4gIC8vLyBiYWNrZ3JvdW5kIGNvbG9yXHJcbiAgYmFja2dyb3VuZENvbG9yOiBzdHJpbmcgPSAnYmxhY2snO1xyXG4gIC8vLyBkZWZhdWx0IHBhZ2UgY29sb3IgKGVtcHR5IHN0cmluZyBtZWFucyB0cmFuc3BhcmVudClcclxuICBwYWdlQ29sb3I6IHN0cmluZyA9ICd3aGl0ZSc7XHJcbiAgLy8vIHBpeGVsIHBlciBwdFxyXG4gIHBpeGVsUGVyUHQ6IG51bWJlciA9IDM7XHJcbiAgLy8vIGN1c3RvbWl6ZWQgd2F5IHRvIHJldHJpZXZpbmcgZG9tIHN0YXRlXHJcbiAgcmV0cmlldmVET01TdGF0ZTogKCkgPT4gQ29udGFpbmVyRE9NU3RhdGU7XHJcblxyXG4gIC8vLyBTdGF0ZSBmaWVsZHNcclxuXHJcbiAgLy8vIHdoZXRoZXIgc3ZnIGlzIHVwZGF0aW5nIChpbiB0cmlnZ2VyU3ZnVXBkYXRlKVxyXG4gIGlzUmVuZGVyaW5nOiBib29sZWFuID0gZmFsc2U7XHJcbiAgLy8vIHdoZXRoZXIga01vZHVsZSBpcyBpbml0aWFsaXplZFxyXG4gIG1vZHVsZUluaXRpYWxpemVkOiBib29sZWFuID0gZmFsc2U7XHJcbiAgLy8vIHBhdGNoIHF1ZXVlIGZvciB1cGRhdGluZyBkYXRhLlxyXG4gIHBhdGNoUXVldWU6IFtzdHJpbmcsIHN0cmluZ11bXSA9IFtdO1xyXG4gIC8vLyByZXNvdXJjZXMgdG8gZGlzcG9zZVxyXG4gIGRpc3Bvc2VMaXN0OiAoKCkgPT4gdm9pZClbXSA9IFtdO1xyXG4gIC8vLyBjYW52YXMgcmVuZGVyIGN0b2tlblxyXG4gIGNhbnZhc1JlbmRlckNUb2tlbj86IFR5cHN0Q2FuY2VsbGF0aW9uVG9rZW47XHJcblxyXG4gIC8vLyBUaGVyZSBhcmUgdHdvIHNjYWxlcyBpbiB0aGlzIGNsYXNzOiBUaGUgcmVhbCBzY2FsZSBpcyB0byBhZGp1c3QgdGhlIHNpemVcclxuICAvLy8gb2YgYGhvb2tlZEVsZW1gIHRvIGZpdCB0aGUgc3ZnLiBUaGUgdmlydHVhbCBzY2FsZSAoc2NhbGUgcmF0aW8pIGlzIHRvIGxldFxyXG4gIC8vLyB1c2VyIHpvb20gaW4vb3V0IHRoZSBzdmcuIEZvciBleGFtcGxlOlxyXG4gIC8vLyArIHRoZSBkZWZhdWx0IHZhbHVlIG9mIHZpcnR1YWwgc2NhbGUgaXMgMSwgd2hpY2ggbWVhbnMgdGhlIHN2ZyBpcyB0b3RhbGx5XHJcbiAgLy8vICAgZml0IGluIGBob29rZWRFbGVtYC5cclxuICAvLy8gKyBpZiB1c2VyIHNldCB2aXJ0dWFsIHNjYWxlIHRvIDAuNSwgdGhlbiB0aGUgc3ZnIHdpbGwgYmUgem9vbWVkIG91dCB0byBmaXRcclxuICAvLy8gICBpbiBoYWxmIHdpZHRoIG9mIGBob29rZWRFbGVtYC4gXCJyZWFsXCIgY3VycmVudCBzY2FsZSBvZiBgaG9va2VkRWxlbWBcclxuICBjdXJyZW50UmVhbFNjYWxlOiBudW1iZXIgPSAxO1xyXG4gIC8vLyBcInZpcnR1YWxcIiBjdXJyZW50IHNjYWxlIG9mIGBob29rZWRFbGVtYFxyXG4gIGN1cnJlbnRTY2FsZVJhdGlvOiBudW1iZXIgPSAxO1xyXG4gIC8vLyB0aW1lb3V0IGZvciBkZWxheWVkIHZpZXdwb3J0IGNoYW5nZVxyXG4gIHZwVGltZW91dDogYW55ID0gdW5kZWZpbmVkO1xyXG4gIC8vLyBzYW1wbGVkIGJ5IGxhc3QgcmVuZGVyIHRpbWUuXHJcbiAgc2FtcGxlZFJlbmRlclRpbWU6IG51bWJlciA9IDA7XHJcbiAgLy8vIHBhZ2UgdG8gcGFydGlhbCByZW5kZXJcclxuICBwYXJ0aWFsUmVuZGVyUGFnZTogbnVtYmVyID0gMDtcclxuICAvLy8gb3V0bGluZSBkYXRhXHJcbiAgb3V0bGluZTogYW55ID0gdW5kZWZpbmVkO1xyXG4gIC8vLyBjdXJzb3IgcG9zaXRpb24gaW4gZm9ybSBvZiBbcGFnZSwgeCwgeV1cclxuICBjdXJzb3JQb3NpdGlvbj86IFtudW1iZXIsIG51bWJlciwgbnVtYmVyXSA9IHVuZGVmaW5lZDtcclxuICAvLyBpZDogbnVtYmVyID0gcm5kKys7XHJcblxyXG4gIC8vLyBDYWNoZSBmaWVsZHNcclxuXHJcbiAgLy8vIGNhY2hlZCBzdGF0ZSBvZiBjb250YWluZXIsIGRlZmF1bHQgdG8gcmV0cmlldmUgc3RhdGUgZnJvbSBgdGhpcy5ob29rZWRFbGVtYFxyXG4gIGNhY2hlZERPTVN0YXRlOiBDb250YWluZXJET01TdGF0ZSA9IHtcclxuICAgIHdpZHRoOiAwLFxyXG4gICAgaGVpZ2h0OiAwLFxyXG4gICAgd2luZG93OiB7XHJcbiAgICAgIGlubmVyV2lkdGg6IDAsXHJcbiAgICAgIGlubmVySGVpZ2h0OiAwLFxyXG4gICAgfSxcclxuICAgIGJvdW5kaW5nUmVjdDoge1xyXG4gICAgICBsZWZ0OiAwLFxyXG4gICAgICB0b3A6IDAsXHJcbiAgICAgIHJpZ2h0OiAwLFxyXG4gICAgfSxcclxuICB9O1xyXG5cclxuICBjb25zdHJ1Y3RvcihvcHRzOiBPcHRpb25zICYgTykge1xyXG4gICAgdGhpcy5ob29rZWRFbGVtID0gb3B0cy5ob29rZWRFbGVtO1xyXG4gICAgdGhpcy5rTW9kdWxlID0gb3B0cy5rTW9kdWxlO1xyXG4gICAgdGhpcy5vcHRzID0gb3B0cyB8fCB7fTtcclxuXHJcbiAgICAvLy8gQXBwbHkgY29uZmlndXJhdGlvblxyXG4gICAge1xyXG4gICAgICBjb25zdCB7IHJlbmRlck1vZGUsIHByZXZpZXdNb2RlLCBpc0NvbnRlbnRQcmV2aWV3LCByZXRyaWV2ZURPTVN0YXRlIH0gPSBvcHRzIHx8IHt9O1xyXG4gICAgICB0aGlzLnBhcnRpYWxSZW5kZXJpbmcgPSBmYWxzZTtcclxuICAgICAgdGhpcy5yZW5kZXJNb2RlID0gcmVuZGVyTW9kZSA/PyB0aGlzLnJlbmRlck1vZGU7XHJcbiAgICAgIHRoaXMucHJldmlld01vZGUgPSBwcmV2aWV3TW9kZSA/PyB0aGlzLnByZXZpZXdNb2RlO1xyXG4gICAgICB0aGlzLmlzQ29udGVudFByZXZpZXcgPSBpc0NvbnRlbnRQcmV2aWV3IHx8IGZhbHNlO1xyXG4gICAgICB0aGlzLnJldHJpZXZlRE9NU3RhdGUgPVxyXG4gICAgICAgIHJldHJpZXZlRE9NU3RhdGUgPz9cclxuICAgICAgICAoKCkgPT4ge1xyXG4gICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgd2lkdGg6IHRoaXMuaG9va2VkRWxlbS5vZmZzZXRXaWR0aCxcclxuICAgICAgICAgICAgaGVpZ2h0OiB0aGlzLmhvb2tlZEVsZW0ub2Zmc2V0SGVpZ2h0LFxyXG4gICAgICAgICAgICB3aW5kb3c6IHtcclxuICAgICAgICAgICAgICBpbm5lcldpZHRoOiB3aW5kb3cuaW5uZXJXaWR0aCxcclxuICAgICAgICAgICAgICBpbm5lckhlaWdodDogd2luZG93LmlubmVySGVpZ2h0LFxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBib3VuZGluZ1JlY3Q6IHRoaXMuaG9va2VkRWxlbS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKSxcclxuICAgICAgICAgIH07XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIHRoaXMuYmFja2dyb3VuZENvbG9yID0gZ2V0Q29tcHV0ZWRTdHlsZShkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQpLmdldFByb3BlcnR5VmFsdWUoXHJcbiAgICAgICAgJy0tdHlwc3QtcHJldmlldy1iYWNrZ3JvdW5kLWNvbG9yJyxcclxuICAgICAgKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBpZiBpbml0IHNjYWxlID09IDFcclxuICAgIC8vIGhpZGUgc2Nyb2xsYmFyIGlmIHNjYWxlID09IDFcclxuXHJcbiAgICB0aGlzLmhvb2tlZEVsZW0uY2xhc3NMaXN0LmFkZCgnaGlkZS1zY3JvbGxiYXIteCcpO1xyXG4gICAgdGhpcy5ob29rZWRFbGVtLnBhcmVudEVsZW1lbnQ/LmNsYXNzTGlzdC5hZGQoJ2hpZGUtc2Nyb2xsYmFyLXgnKTtcclxuICAgIGlmICh0aGlzLnByZXZpZXdNb2RlID09PSBQcmV2aWV3TW9kZS5TbGlkZSkge1xyXG4gICAgICB0aGlzLmhvb2tlZEVsZW0uY2xhc3NMaXN0LmFkZCgnaGlkZS1zY3JvbGxiYXIteScpO1xyXG4gICAgICB0aGlzLmhvb2tlZEVsZW0ucGFyZW50RWxlbWVudD8uY2xhc3NMaXN0LmFkZCgnaGlkZS1zY3JvbGxiYXIteScpO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMuaW5zdGFsbEN0cmxXaGVlbEhhbmRsZXIoKTtcclxuICB9XHJcblxyXG4gIHJlc2V0KCkge1xyXG4gICAgdGhpcy5rTW9kdWxlLnJlc2V0KCk7XHJcbiAgICB0aGlzLm1vZHVsZUluaXRpYWxpemVkID0gZmFsc2U7XHJcbiAgfVxyXG5cclxuICBkaXNwb3NlKCkge1xyXG4gICAgY29uc3QgZGlzcG9zZUxpc3QgPSB0aGlzLmRpc3Bvc2VMaXN0O1xyXG4gICAgdGhpcy5kaXNwb3NlTGlzdCA9IFtdO1xyXG4gICAgZGlzcG9zZUxpc3QuZm9yRWFjaCh4ID0+IHgoKSk7XHJcbiAgfVxyXG5cclxuICBzdGF0aWMgZGVyaXZlKGN0eDogYW55LCBtb2RlOiBzdHJpbmcpIHtcclxuICAgIHJldHVybiBbJ3Jlc2NhbGUnLCAncmVyZW5kZXInLCAncG9zdFJlbmRlciddLnJlZHVjZSgoYWNjOiBhbnksIHg6IHN0cmluZykgPT4ge1xyXG4gICAgICBhY2NbeF0gPSBjdHhbYCR7eH0kJHttb2RlfWBdLmJpbmQoY3R4KTtcclxuICAgICAgY29uc29sZS5hc3NlcnQoYWNjW3hdICE9PSB1bmRlZmluZWQsIGAke3h9JCR7bW9kZX0gaXMgdW5kZWZpbmVkYCk7XHJcbiAgICAgIHJldHVybiBhY2M7XHJcbiAgICB9LCB7fSBhcyBUeXBzdERvY3VtZW50RmFjYWRlKTtcclxuICB9XHJcblxyXG4gIHJlZ2lzdGVyTW9kZShtb2RlOiBhbnkpIHtcclxuICAgIGNvbnN0IGZhY2FkZSA9IFR5cHN0RG9jdW1lbnRDb250ZXh0LmRlcml2ZSh0aGlzLCBtb2RlKTtcclxuICAgIHRoaXMubW9kZXMucHVzaChbbW9kZSwgZmFjYWRlXSk7XHJcbiAgICBpZiAobW9kZSA9PT0gdGhpcy5yZW5kZXJNb2RlKSB7XHJcbiAgICAgIHRoaXMuciA9IGZhY2FkZTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgaW5zdGFsbEN0cmxXaGVlbEhhbmRsZXIoKSB7XHJcbiAgICAvLyBDdHJsK3Njcm9sbCByZXNjYWxpbmdcclxuICAgIC8vIHdpbGwgZGlzYWJsZSBhdXRvIHJlc2l6aW5nXHJcbiAgICAvLyBmaXhlZCBmYWN0b3JzLCBzYW1lIGFzIHBkZi5qc1xyXG4gICAgY29uc3QgZmFjdG9ycyA9IFtcclxuICAgICAgMC4xLCAwLjIsIDAuMywgMC40LCAwLjUsIDAuNiwgMC43LCAwLjgsIDAuOSwgMSwgMS4xLCAxLjMsIDEuNSwgMS43LCAxLjksIDIuMSwgMi40LCAyLjcsIDMsXHJcbiAgICAgIDMuMywgMy43LCA0LjEsIDQuNiwgNS4xLCA1LjcsIDYuMywgNywgNy43LCA4LjUsIDkuNCwgMTAsXHJcbiAgICBdO1xyXG4gICAgY29uc3Qgd2hlZWxFdmVudEhhbmRsZXIgPSAoZXZlbnQ6IFdoZWVsRXZlbnQpID0+IHtcclxuICAgICAgaWYgKGV2ZW50LmN0cmxLZXkpIHtcclxuICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgICAgIC8vIHJldHJpZXZlIGRvbSBzdGF0ZSBiZWZvcmUgYW55IG9wZXJhdGlvblxyXG4gICAgICAgIHRoaXMuY2FjaGVkRE9NU3RhdGUgPSB0aGlzLnJldHJpZXZlRE9NU3RhdGUoKTtcclxuICAgICAgICBpZiAod2luZG93Lm9ucmVzaXplICE9PSBudWxsKSB7XHJcbiAgICAgICAgICAvLyBpcyBhdXRvIHJlc2l6aW5nXHJcbiAgICAgICAgICB3aW5kb3cub25yZXNpemUgPSBudWxsO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBwcmV2U2NhbGVSYXRpbyA9IHRoaXMuY3VycmVudFNjYWxlUmF0aW87XHJcbiAgICAgICAgLy8gR2V0IHdoZWVsIHNjcm9sbCBkaXJlY3Rpb24gYW5kIGNhbGN1bGF0ZSBuZXcgc2NhbGVcclxuICAgICAgICBpZiAoZXZlbnQuZGVsdGFZIDwgMCkge1xyXG4gICAgICAgICAgLy8gZW5sYXJnZVxyXG4gICAgICAgICAgaWYgKHRoaXMuY3VycmVudFNjYWxlUmF0aW8gPj0gZmFjdG9ycy5hdCgtMSkhKSB7XHJcbiAgICAgICAgICAgIC8vIGFscmVhZHkgbGFyZ2UgdGhhbiBtYXggZmFjdG9yXHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMuY3VycmVudFNjYWxlUmF0aW8gPSBmYWN0b3JzLmZpbHRlcih4ID0+IHggPiB0aGlzLmN1cnJlbnRTY2FsZVJhdGlvKS5hdCgwKSE7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIGlmIChldmVudC5kZWx0YVkgPiAwKSB7XHJcbiAgICAgICAgICAvLyByZWR1Y2VcclxuICAgICAgICAgIGlmICh0aGlzLmN1cnJlbnRTY2FsZVJhdGlvIDw9IGZhY3RvcnMuYXQoMCkhKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMuY3VycmVudFNjYWxlUmF0aW8gPSBmYWN0b3JzLmZpbHRlcih4ID0+IHggPCB0aGlzLmN1cnJlbnRTY2FsZVJhdGlvKS5hdCgtMSkhO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAvLyBubyB5LWF4aXMgc2Nyb2xsXHJcbiAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IHNjcm9sbEZhY3RvciA9IHRoaXMuY3VycmVudFNjYWxlUmF0aW8gLyBwcmV2U2NhbGVSYXRpbztcclxuICAgICAgICBjb25zdCBzY3JvbGxYID0gZXZlbnQucGFnZVggKiAoc2Nyb2xsRmFjdG9yIC0gMSk7XHJcbiAgICAgICAgY29uc3Qgc2Nyb2xsWSA9IGV2ZW50LnBhZ2VZICogKHNjcm9sbEZhY3RvciAtIDEpO1xyXG4gICAgICAgIC8vIGhpZGUgc2Nyb2xsYmFyIGlmIHNjYWxlID09IDFcclxuICAgICAgICBpZiAoTWF0aC5hYnModGhpcy5jdXJyZW50U2NhbGVSYXRpbyAtIDEpIDwgMWUtNSkge1xyXG4gICAgICAgICAgdGhpcy5ob29rZWRFbGVtLmNsYXNzTGlzdC5hZGQoJ2hpZGUtc2Nyb2xsYmFyLXgnKTtcclxuICAgICAgICAgIHRoaXMuaG9va2VkRWxlbS5wYXJlbnRFbGVtZW50Py5jbGFzc0xpc3QuYWRkKCdoaWRlLXNjcm9sbGJhci14Jyk7XHJcbiAgICAgICAgICBpZiAodGhpcy5wcmV2aWV3TW9kZSA9PT0gUHJldmlld01vZGUuU2xpZGUpIHtcclxuICAgICAgICAgICAgdGhpcy5ob29rZWRFbGVtLmNsYXNzTGlzdC5hZGQoJ2hpZGUtc2Nyb2xsYmFyLXknKTtcclxuICAgICAgICAgICAgdGhpcy5ob29rZWRFbGVtLnBhcmVudEVsZW1lbnQ/LmNsYXNzTGlzdC5hZGQoJ2hpZGUtc2Nyb2xsYmFyLXknKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgdGhpcy5ob29rZWRFbGVtLmNsYXNzTGlzdC5yZW1vdmUoJ2hpZGUtc2Nyb2xsYmFyLXgnKTtcclxuICAgICAgICAgIHRoaXMuaG9va2VkRWxlbS5wYXJlbnRFbGVtZW50Py5jbGFzc0xpc3QucmVtb3ZlKCdoaWRlLXNjcm9sbGJhci14Jyk7XHJcbiAgICAgICAgICBpZiAodGhpcy5wcmV2aWV3TW9kZSA9PT0gUHJldmlld01vZGUuU2xpZGUpIHtcclxuICAgICAgICAgICAgdGhpcy5ob29rZWRFbGVtLmNsYXNzTGlzdC5yZW1vdmUoJ2hpZGUtc2Nyb2xsYmFyLXknKTtcclxuICAgICAgICAgICAgdGhpcy5ob29rZWRFbGVtLnBhcmVudEVsZW1lbnQ/LmNsYXNzTGlzdC5yZW1vdmUoJ2hpZGUtc2Nyb2xsYmFyLXknKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgLy8gcmVzZXJ2ZSBzcGFjZSB0byBzY3JvbGwgZG93blxyXG4gICAgICAgIGNvbnN0IHN2ZyA9IHRoaXMuaG9va2VkRWxlbS5maXJzdEVsZW1lbnRDaGlsZCEgYXMgU1ZHRWxlbWVudDtcclxuICAgICAgICBpZiAoc3ZnKSB7XHJcbiAgICAgICAgICBjb25zdCBzY2FsZVJhdGlvID0gdGhpcy5nZXRTdmdTY2FsZVJhdGlvKCk7XHJcbiAgICAgICAgICBjb25zdCBkYXRhSGVpZ2h0ID0gTnVtYmVyLnBhcnNlRmxvYXQoc3ZnLmdldEF0dHJpYnV0ZSgnZGF0YS1oZWlnaHQnKSEpO1xyXG4gICAgICAgICAgY29uc3Qgc2NhbGVkSGVpZ2h0ID0gTWF0aC5jZWlsKGRhdGFIZWlnaHQgKiBzY2FsZVJhdGlvKTtcclxuICAgICAgICAgIC8vIHdlIGluY3JlYXNlIHRoZSBoZWlnaHQgYnkgMiB0aW1lcy5cclxuICAgICAgICAgIC8vIFRoZSBgMmAgaXMgb25seSBhIG1hZ2ljIG51bWJlciB0aGF0IGlzIGxhcmdlIGVub3VnaC5cclxuICAgICAgICAgIHRoaXMuaG9va2VkRWxlbS5zdHlsZS5oZWlnaHQgPSBgJHtzY2FsZWRIZWlnaHQgKiAyfXB4YDtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8gbWFrZSBzdXJlIHRoZSBjdXJzb3IgaXMgc3RpbGwgb24gdGhlIHNhbWUgcG9zaXRpb25cclxuICAgICAgICB3aW5kb3cuc2Nyb2xsQnkoc2Nyb2xsWCwgc2Nyb2xsWSk7XHJcbiAgICAgICAgLy8gdG9nZ2xlIHNjYWxlIGNoYW5nZSBldmVudFxyXG4gICAgICAgIHRoaXMuYWRkVmlld3BvcnRDaGFuZ2UoKTtcclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgIH1cclxuICAgIH07XHJcblxyXG4gICAgaWYgKHRoaXMucmVuZGVyTW9kZSAhPT0gJ2RvbScpIHtcclxuICAgICAgY29uc3QgdnNjb2RlQVBJID0gdHlwZW9mIGFjcXVpcmVWc0NvZGVBcGkgIT09ICd1bmRlZmluZWQnO1xyXG4gICAgICBpZiAodnNjb2RlQVBJKSB7XHJcbiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3doZWVsJywgd2hlZWxFdmVudEhhbmRsZXIsIHtcclxuICAgICAgICAgIHBhc3NpdmU6IGZhbHNlLFxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHRoaXMuZGlzcG9zZUxpc3QucHVzaCgoKSA9PiB7XHJcbiAgICAgICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcignd2hlZWwnLCB3aGVlbEV2ZW50SGFuZGxlcik7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgZG9jdW1lbnQuYm9keS5hZGRFdmVudExpc3RlbmVyKCd3aGVlbCcsIHdoZWVsRXZlbnRIYW5kbGVyLCB7XHJcbiAgICAgICAgICBwYXNzaXZlOiBmYWxzZSxcclxuICAgICAgICB9KTtcclxuICAgICAgICB0aGlzLmRpc3Bvc2VMaXN0LnB1c2goKCkgPT4ge1xyXG4gICAgICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVFdmVudExpc3RlbmVyKCd3aGVlbCcsIHdoZWVsRXZlbnRIYW5kbGVyKTtcclxuICAgICAgICB9KTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLy8vIEdldCBjdXJyZW50IHNjYWxlIGZyb20gaHRtbCB0byBzdmdcclxuICAvLyBOb3RlOiBvbmUgc2hvdWxkIHJldHJpZXZlIGRvbSBzdGF0ZSBiZWZvcmUgcmVzY2FsZVxyXG4gIGdldFN2Z1NjYWxlUmF0aW8oKSB7XHJcbiAgICBjb25zdCBzdmcgPSB0aGlzLmhvb2tlZEVsZW0uZmlyc3RFbGVtZW50Q2hpbGQgYXMgU1ZHRWxlbWVudDtcclxuICAgIGlmICghc3ZnKSB7XHJcbiAgICAgIHJldHVybiAwO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGNvbnRhaW5lciA9IHRoaXMuY2FjaGVkRE9NU3RhdGU7XHJcblxyXG4gICAgY29uc3Qgc3ZnV2lkdGggPSBOdW1iZXIucGFyc2VGbG9hdChcclxuICAgICAgc3ZnLmdldEF0dHJpYnV0ZSgnZGF0YS13aWR0aCcpIHx8IHN2Zy5nZXRBdHRyaWJ1dGUoJ3dpZHRoJykgfHwgJzEnLFxyXG4gICAgKTtcclxuICAgIGNvbnN0IHN2Z0hlaWdodCA9IE51bWJlci5wYXJzZUZsb2F0KFxyXG4gICAgICBzdmcuZ2V0QXR0cmlidXRlKCdkYXRhLWhlaWdodCcpIHx8IHN2Zy5nZXRBdHRyaWJ1dGUoJ2hlaWdodCcpIHx8ICcxJyxcclxuICAgICk7XHJcbiAgICB0aGlzLmN1cnJlbnRSZWFsU2NhbGUgPVxyXG4gICAgICB0aGlzLnByZXZpZXdNb2RlID09PSBQcmV2aWV3TW9kZS5TbGlkZVxyXG4gICAgICAgID8gTWF0aC5taW4oY29udGFpbmVyLndpZHRoIC8gc3ZnV2lkdGgsIGNvbnRhaW5lci5oZWlnaHQgLyBzdmdIZWlnaHQpXHJcbiAgICAgICAgOiBjb250YWluZXIud2lkdGggLyBzdmdXaWR0aDtcclxuXHJcbiAgICByZXR1cm4gdGhpcy5jdXJyZW50UmVhbFNjYWxlICogdGhpcy5jdXJyZW50U2NhbGVSYXRpbztcclxuICB9XHJcblxyXG4gIHByaXZhdGUgcHJvY2Vzc1F1ZXVlKHN2Z1VwZGF0ZUV2ZW50OiBbc3RyaW5nLCBzdHJpbmddKTogYm9vbGVhbiB7XHJcbiAgICBjb25zdCBldmVudE5hbWUgPSBzdmdVcGRhdGVFdmVudFswXTtcclxuICAgIHN3aXRjaCAoZXZlbnROYW1lKSB7XHJcbiAgICAgIGNhc2UgJ25ldyc6XHJcbiAgICAgIGNhc2UgJ2RpZmYtdjEnOiB7XHJcbiAgICAgICAgaWYgKGV2ZW50TmFtZSA9PT0gJ25ldycpIHtcclxuICAgICAgICAgIHRoaXMucmVzZXQoKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5rTW9kdWxlLm1hbmlwdWxhdGVEYXRhKHtcclxuICAgICAgICAgIGFjdGlvbjogJ21lcmdlJyxcclxuICAgICAgICAgIGRhdGE6IHN2Z1VwZGF0ZUV2ZW50WzFdIGFzIHVua25vd24gYXMgVWludDhBcnJheSxcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgdGhpcy5tb2R1bGVJbml0aWFsaXplZCA9IHRydWU7XHJcbiAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgIH1cclxuICAgICAgY2FzZSAndmlld3BvcnQtY2hhbmdlJzoge1xyXG4gICAgICAgIGlmICghdGhpcy5tb2R1bGVJbml0aWFsaXplZCkge1xyXG4gICAgICAgICAgY29uc29sZS5sb2coJ3ZpZXdwb3J0LWNoYW5nZSBiZWZvcmUgaW5pdGlhbGl6YXRpb24nKTtcclxuICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgIH1cclxuICAgICAgZGVmYXVsdDpcclxuICAgICAgICBjb25zb2xlLmxvZygnc3ZnVXBkYXRlRXZlbnQnLCBzdmdVcGRhdGVFdmVudCk7XHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSB0cmlnZ2VyVXBkYXRlKCkge1xyXG4gICAgaWYgKHRoaXMuaXNSZW5kZXJpbmcpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMuaXNSZW5kZXJpbmcgPSB0cnVlO1xyXG4gICAgY29uc3QgZG9VcGRhdGUgPSBhc3luYyAoKSA9PiB7XHJcbiAgICAgIHRoaXMuY2FjaGVkRE9NU3RhdGUgPSB0aGlzLnJldHJpZXZlRE9NU3RhdGUoKTtcclxuXHJcbiAgICAgIGlmICh0aGlzLnBhdGNoUXVldWUubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgdGhpcy5pc1JlbmRlcmluZyA9IGZhbHNlO1xyXG4gICAgICAgIHRoaXMucG9zdHByb2Nlc3NDaGFuZ2VzKCk7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcblxyXG4gICAgICB0cnkge1xyXG4gICAgICAgIGxldCB0MCA9IHBlcmZvcm1hbmNlLm5vdygpO1xyXG5cclxuICAgICAgICBjb25zdCBjdG9rZW4gPSB0aGlzLmNhbnZhc1JlbmRlckNUb2tlbjtcclxuICAgICAgICBpZiAoY3Rva2VuKSB7XHJcbiAgICAgICAgICBhd2FpdCBjdG9rZW4uY2FuY2VsKCk7XHJcbiAgICAgICAgICBhd2FpdCBjdG9rZW4ud2FpdCgpO1xyXG4gICAgICAgICAgdGhpcy5jYW52YXNSZW5kZXJDVG9rZW4gPSB1bmRlZmluZWQ7XHJcbiAgICAgICAgICBjb25zb2xlLmxvZygnY2FuY2VsIGNhbnZhcyByZW5kZXJpbmcnKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGxldCBuZWVkUmVyZW5kZXIgPSBmYWxzZTtcclxuICAgICAgICAvLyBjb25zb2xlLmxvZygncGF0Y2hRdWV1ZScsIEpTT04uc3RyaW5naWZ5KHRoaXMucGF0Y2hRdWV1ZS5tYXAoeCA9PiB4WzBdKSkpO1xyXG4gICAgICAgIHdoaWxlICh0aGlzLnBhdGNoUXVldWUubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgbmVlZFJlcmVuZGVyID0gdGhpcy5wcm9jZXNzUXVldWUodGhpcy5wYXRjaFF1ZXVlLnNoaWZ0KCkhKSB8fCBuZWVkUmVyZW5kZXI7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyB0b2RvOiB0cmlnZ2VyIHZpZXdwb3J0IGNoYW5nZSBvbmNlXHJcbiAgICAgICAgbGV0IHQxID0gcGVyZm9ybWFuY2Uubm93KCk7XHJcbiAgICAgICAgaWYgKG5lZWRSZXJlbmRlcikge1xyXG4gICAgICAgICAgdGhpcy5yLnJlc2NhbGUoKTtcclxuICAgICAgICAgIGF3YWl0IHRoaXMuci5yZXJlbmRlcigpO1xyXG4gICAgICAgICAgdGhpcy5yLnJlc2NhbGUoKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgbGV0IHQyID0gcGVyZm9ybWFuY2Uubm93KCk7XHJcblxyXG4gICAgICAgIC8vLyBwZXJmIGV2ZW50XHJcbiAgICAgICAgY29uc3QgZCA9IChlOiBzdHJpbmcsIHg6IG51bWJlciwgeTogbnVtYmVyKSA9PiBgJHtlfSAkeyh5IC0geCkudG9GaXhlZCgyKX0gbXNgO1xyXG4gICAgICAgIHRoaXMuc2FtcGxlZFJlbmRlclRpbWUgPSB0MiAtIHQwO1xyXG4gICAgICAgIGNvbnNvbGUubG9nKFtkKCdwYXJzZScsIHQwLCB0MSksIGQoJ3JlcmVuZGVyJywgdDEsIHQyKSwgZCgndG90YWwnLCB0MCwgdDIpXS5qb2luKCcsICcpKTtcclxuXHJcbiAgICAgICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKGRvVXBkYXRlKTtcclxuICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgIGNvbnNvbGUuZXJyb3IoZSk7XHJcbiAgICAgICAgdGhpcy5pc1JlbmRlcmluZyA9IGZhbHNlO1xyXG4gICAgICAgIHRoaXMucG9zdHByb2Nlc3NDaGFuZ2VzKCk7XHJcbiAgICAgIH1cclxuICAgIH07XHJcbiAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoZG9VcGRhdGUpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBwb3N0cHJvY2Vzc0NoYW5nZXMoKSB7XHJcbiAgICB0aGlzLnIucG9zdFJlbmRlcigpO1xyXG5cclxuICAgIC8vIHRvZG86IGFic3RyYWN0IHRoaXNcclxuICAgIGlmICh0aGlzLnByZXZpZXdNb2RlID09PSBQcmV2aWV3TW9kZS5TbGlkZSkge1xyXG4gICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCcudHlwc3QtcGFnZS1udW1iZXItaW5kaWNhdG9yJykuZm9yRWFjaCh4ID0+IHtcclxuICAgICAgICB4LnRleHRDb250ZW50ID0gYCR7dGhpcy5rTW9kdWxlLnJldHJpZXZlUGFnZXNJbmZvKCkubGVuZ3RofWA7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgYWRkQ2hhbmdlbWVudChjaGFuZ2U6IFtzdHJpbmcsIHN0cmluZ10pIHtcclxuICAgIGlmIChjaGFuZ2VbMF0gPT09ICduZXcnKSB7XHJcbiAgICAgIHRoaXMucGF0Y2hRdWV1ZS5zcGxpY2UoMCwgdGhpcy5wYXRjaFF1ZXVlLmxlbmd0aCk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgcHVzaENoYW5nZSA9ICgpID0+IHtcclxuICAgICAgdGhpcy52cFRpbWVvdXQgPSB1bmRlZmluZWQ7XHJcbiAgICAgIHRoaXMucGF0Y2hRdWV1ZS5wdXNoKGNoYW5nZSk7XHJcbiAgICAgIHRoaXMudHJpZ2dlclVwZGF0ZSgpO1xyXG4gICAgfTtcclxuXHJcbiAgICBpZiAodGhpcy52cFRpbWVvdXQgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICBjbGVhclRpbWVvdXQodGhpcy52cFRpbWVvdXQpO1xyXG4gICAgfVxyXG5cclxuICAgIGlmIChjaGFuZ2VbMF0gPT09ICd2aWV3cG9ydC1jaGFuZ2UnICYmIHRoaXMuaXNSZW5kZXJpbmcpIHtcclxuICAgICAgLy8gZGVsYXkgdmlld3BvcnQgY2hhbmdlIGEgYml0XHJcbiAgICAgIHRoaXMudnBUaW1lb3V0ID0gc2V0VGltZW91dChwdXNoQ2hhbmdlLCB0aGlzLnNhbXBsZWRSZW5kZXJUaW1lIHx8IDEwMCk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBwdXNoQ2hhbmdlKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBhZGRWaWV3cG9ydENoYW5nZSgpIHtcclxuICAgIHRoaXMuYWRkQ2hhbmdlbWVudChbJ3ZpZXdwb3J0LWNoYW5nZScsICcnXSk7XHJcbiAgfVxyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIFR5cHN0RG9jdW1lbnQ8VD4ge1xyXG4gIGltcGw6IFQ7XHJcbiAga01vZHVsZTogUmVuZGVyU2Vzc2lvbjtcclxuICBkaXNwb3NlKCk6IHZvaWQ7XHJcbiAgcmVzZXQoKTogdm9pZDtcclxuICBhZGRDaGFuZ2VtZW50KGNoYW5nZTogW3N0cmluZywgc3RyaW5nXSk6IHZvaWQ7XHJcbiAgYWRkVmlld3BvcnRDaGFuZ2UoKTogdm9pZDtcclxuICBzZXRQYWdlQ29sb3IoY29sb3I6IHN0cmluZyk6IHZvaWQ7XHJcbiAgc2V0UGFydGlhbFJlbmRlcmluZyhwYXJ0aWFsUmVuZGVyaW5nOiBib29sZWFuKTogdm9pZDtcclxuICBzZXRDdXJzb3IocGFnZTogbnVtYmVyLCB4OiBudW1iZXIsIHk6IG51bWJlcik6IHZvaWQ7XHJcbiAgc2V0UGFydGlhbFBhZ2VOdW1iZXIocGFnZTogbnVtYmVyKTogYm9vbGVhbjtcclxuICBnZXRQYXJ0aWFsUGFnZU51bWJlcigpOiBudW1iZXI7XHJcbiAgc2V0T3V0aW5lRGF0YShvdXRsaW5lOiBhbnkpOiB2b2lkO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gcHJvdmlkZURvYzxUIGV4dGVuZHMgVHlwc3REb2N1bWVudENvbnRleHQ+KFxyXG4gIEJhc2U6IEdDb25zdHJ1Y3RvcjxUPixcclxuKTogbmV3IChvcHRpb25zOiBPcHRpb25zICYgVFsnb3B0cyddKSA9PiBUeXBzdERvY3VtZW50PFQ+IHtcclxuICByZXR1cm4gY2xhc3MgVHlwc3REb2N1bWVudCB7XHJcbiAgICBwdWJsaWMgaW1wbDogVDtcclxuICAgIHB1YmxpYyBrTW9kdWxlOiBSZW5kZXJTZXNzaW9uO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKG9wdGlvbnM6IE9wdGlvbnMpIHtcclxuICAgICAgaWYgKG9wdGlvbnMuaXNDb250ZW50UHJldmlldykge1xyXG4gICAgICAgIG9wdGlvbnMucmVuZGVyTW9kZSA9ICdjYW52YXMnO1xyXG4gICAgICB9XHJcblxyXG4gICAgICB0aGlzLmtNb2R1bGUgPSBvcHRpb25zLmtNb2R1bGU7XHJcbiAgICAgIHRoaXMuaW1wbCA9IG5ldyBCYXNlKG9wdGlvbnMpO1xyXG4gICAgICBpZiAoIXRoaXMuaW1wbC5yKSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBtb2RlIGlzIG5vdCBzdXBwb3J0ZWQsICR7b3B0aW9ucz8ucmVuZGVyTW9kZX1gKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgaWYgKG9wdGlvbnMuaXNDb250ZW50UHJldmlldykge1xyXG4gICAgICAgIC8vIGNvbnRlbnQgcHJldmlldyBoYXMgdmVyeSBiYWQgcGVyZm9ybWFuY2Ugd2l0aG91dCBwYXJ0aWFsIHJlbmRlcmluZ1xyXG4gICAgICAgIHRoaXMuaW1wbC5wYXJ0aWFsUmVuZGVyaW5nID0gdHJ1ZTtcclxuICAgICAgICB0aGlzLmltcGwucGl4ZWxQZXJQdCA9IDE7XHJcbiAgICAgICAgdGhpcy5pbXBsLmlzTWl4aW5PdXRsaW5lID0gdHJ1ZTtcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGRpc3Bvc2UoKSB7XHJcbiAgICAgIHRoaXMuaW1wbC5kaXNwb3NlKCk7XHJcbiAgICB9XHJcblxyXG4gICAgcmVzZXQoKSB7XHJcbiAgICAgIHRoaXMuaW1wbC5yZXNldCgpO1xyXG4gICAgfVxyXG5cclxuICAgIGFkZENoYW5nZW1lbnQoY2hhbmdlOiBbc3RyaW5nLCBzdHJpbmddKSB7XHJcbiAgICAgIHRoaXMuaW1wbC5hZGRDaGFuZ2VtZW50KGNoYW5nZSk7XHJcbiAgICB9XHJcblxyXG4gICAgYWRkVmlld3BvcnRDaGFuZ2UoKSB7XHJcbiAgICAgIHRoaXMuaW1wbC5hZGRWaWV3cG9ydENoYW5nZSgpO1xyXG4gICAgfVxyXG5cclxuICAgIHNldFBhZ2VDb2xvcihjb2xvcjogc3RyaW5nKSB7XHJcbiAgICAgIHRoaXMuaW1wbC5wYWdlQ29sb3IgPSBjb2xvcjtcclxuICAgICAgdGhpcy5hZGRWaWV3cG9ydENoYW5nZSgpO1xyXG4gICAgfVxyXG5cclxuICAgIHNldFBhcnRpYWxSZW5kZXJpbmcocGFydGlhbFJlbmRlcmluZzogYm9vbGVhbikge1xyXG4gICAgICB0aGlzLmltcGwucGFydGlhbFJlbmRlcmluZyA9IHBhcnRpYWxSZW5kZXJpbmc7XHJcbiAgICB9XHJcblxyXG4gICAgc2V0Q3Vyc29yKHBhZ2U6IG51bWJlciwgeDogbnVtYmVyLCB5OiBudW1iZXIpIHtcclxuICAgICAgdGhpcy5pbXBsLmN1cnNvclBvc2l0aW9uID0gW3BhZ2UsIHgsIHldO1xyXG4gICAgfVxyXG5cclxuICAgIHNldFBhcnRpYWxQYWdlTnVtYmVyKHBhZ2U6IG51bWJlcik6IGJvb2xlYW4ge1xyXG4gICAgICBpZiAocGFnZSA8PSAwIHx8IHBhZ2UgPiB0aGlzLmtNb2R1bGUucmV0cmlldmVQYWdlc0luZm8oKS5sZW5ndGgpIHtcclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgIH1cclxuICAgICAgdGhpcy5pbXBsLnBhcnRpYWxSZW5kZXJQYWdlID0gcGFnZSAtIDE7XHJcbiAgICAgIHRoaXMuYWRkVmlld3BvcnRDaGFuZ2UoKTtcclxuICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0UGFydGlhbFBhZ2VOdW1iZXIoKTogbnVtYmVyIHtcclxuICAgICAgcmV0dXJuIHRoaXMuaW1wbC5wYXJ0aWFsUmVuZGVyUGFnZSArIDE7XHJcbiAgICB9XHJcblxyXG4gICAgc2V0T3V0aW5lRGF0YShvdXRsaW5lOiBhbnkpIHtcclxuICAgICAgdGhpcy5pbXBsLm91dGxpbmUgPSBvdXRsaW5lO1xyXG4gICAgICB0aGlzLmFkZFZpZXdwb3J0Q2hhbmdlKCk7XHJcbiAgICB9XHJcbiAgfTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGNvbXBvc2VEb2M8VEJhc2UgZXh0ZW5kcyBHQ29uc3RydWN0b3IsIEYxPihcclxuICBCYXNlOiBUQmFzZSxcclxuICBmMTogKGJhc2U6IFRCYXNlKSA9PiBGMSxcclxuKTogVEJhc2UgJiBGMTtcclxuZXhwb3J0IGZ1bmN0aW9uIGNvbXBvc2VEb2M8VEJhc2UgZXh0ZW5kcyBHQ29uc3RydWN0b3IsIEYxLCBGMj4oXHJcbiAgQmFzZTogVEJhc2UsXHJcbiAgZjE6IChiYXNlOiBUQmFzZSkgPT4gRjEsXHJcbiAgZjI6IChiYXNlOiBGMSkgPT4gRjIsXHJcbik6IFRCYXNlICYgRjEgJiBGMjtcclxuZXhwb3J0IGZ1bmN0aW9uIGNvbXBvc2VEb2M8VEJhc2UgZXh0ZW5kcyBHQ29uc3RydWN0b3IsIEYxLCBGMiwgRjM+KFxyXG4gIEJhc2U6IFRCYXNlLFxyXG4gIGYxOiAoYmFzZTogVEJhc2UpID0+IEYxLFxyXG4gIGYyOiAoYmFzZTogRjEpID0+IEYyLFxyXG4gIGYzOiAoYmFzZTogRjIpID0+IEYzLFxyXG4pOiBUQmFzZSAmIEYxICYgRjIgJiBGMztcclxuZXhwb3J0IGZ1bmN0aW9uIGNvbXBvc2VEb2M8VEJhc2UgZXh0ZW5kcyBHQ29uc3RydWN0b3IsIEYxLCBGMiwgRjMsIEY0PihcclxuICBCYXNlOiBUQmFzZSxcclxuICBmMTogKGJhc2U6IFRCYXNlKSA9PiBGMSxcclxuICBmMjogKGJhc2U6IEYxKSA9PiBGMixcclxuICBmMzogKGJhc2U6IEYyKSA9PiBGMyxcclxuICBmNDogKGJhc2U6IEYzKSA9PiBGNCxcclxuKTogVEJhc2UgJiBGMSAmIEYyICYgRjMgJiBGNDtcclxuZXhwb3J0IGZ1bmN0aW9uIGNvbXBvc2VEb2M8VEJhc2UgZXh0ZW5kcyBHQ29uc3RydWN0b3IsIEYxLCBGMiwgRjMsIEY0LCBGNT4oXHJcbiAgQmFzZTogVEJhc2UsXHJcbiAgZjE6IChiYXNlOiBUQmFzZSkgPT4gRjEsXHJcbiAgZjI6IChiYXNlOiBGMSkgPT4gRjIsXHJcbiAgZjM6IChiYXNlOiBGMikgPT4gRjMsXHJcbiAgZjQ6IChiYXNlOiBGMykgPT4gRjQsXHJcbiAgZjU6IChiYXNlOiBGNCkgPT4gRjUsXHJcbik6IFRCYXNlICYgRjEgJiBGMiAmIEYzICYgRjQgJiBGNTtcclxuZXhwb3J0IGZ1bmN0aW9uIGNvbXBvc2VEb2M8VEJhc2UgZXh0ZW5kcyBHQ29uc3RydWN0b3IsIEYxLCBGMiwgRjMsIEY0LCBGNSwgRjY+KFxyXG4gIEJhc2U6IFRCYXNlLFxyXG4gIGYxOiAoYmFzZTogVEJhc2UpID0+IEYxLFxyXG4gIGYyOiAoYmFzZTogRjEpID0+IEYyLFxyXG4gIGYzOiAoYmFzZTogRjIpID0+IEYzLFxyXG4gIGY0OiAoYmFzZTogRjMpID0+IEY0LFxyXG4gIGY1OiAoYmFzZTogRjQpID0+IEY1LFxyXG4gIGY2OiAoYmFzZTogRjUpID0+IEY2LFxyXG4pOiBUQmFzZSAmIEYxICYgRjIgJiBGMyAmIEY0ICYgRjUgJiBGNjtcclxuZXhwb3J0IGZ1bmN0aW9uIGNvbXBvc2VEb2M8VEJhc2UgZXh0ZW5kcyBHQ29uc3RydWN0b3IsIEYxLCBGMiwgRjMsIEY0LCBGNSwgRjYsIEY3PihcclxuICBCYXNlOiBUQmFzZSxcclxuICBmMTogKGJhc2U6IFRCYXNlKSA9PiBGMSxcclxuICBmMjogKGJhc2U6IEYxKSA9PiBGMixcclxuICBmMzogKGJhc2U6IEYyKSA9PiBGMyxcclxuICBmNDogKGJhc2U6IEYzKSA9PiBGNCxcclxuICBmNTogKGJhc2U6IEY0KSA9PiBGNSxcclxuICBmNjogKGJhc2U6IEY1KSA9PiBGNixcclxuICBmNzogKGJhc2U6IEY2KSA9PiBGNyxcclxuKTogVEJhc2UgJiBGMSAmIEYyICYgRjMgJiBGNCAmIEY1ICYgRjYgJiBGNztcclxuZXhwb3J0IGZ1bmN0aW9uIGNvbXBvc2VEb2M8VEJhc2UgZXh0ZW5kcyBHQ29uc3RydWN0b3IsIEYxLCBGMiwgRjMsIEY0LCBGNSwgRjYsIEY3LCBGOD4oXHJcbiAgQmFzZTogVEJhc2UsXHJcbiAgZjE6IChiYXNlOiBUQmFzZSkgPT4gRjEsXHJcbiAgZjI6IChiYXNlOiBGMSkgPT4gRjIsXHJcbiAgZjM6IChiYXNlOiBGMikgPT4gRjMsXHJcbiAgZjQ6IChiYXNlOiBGMykgPT4gRjQsXHJcbiAgZjU6IChiYXNlOiBGNCkgPT4gRjUsXHJcbiAgZjY6IChiYXNlOiBGNSkgPT4gRjYsXHJcbiAgZjc6IChiYXNlOiBGNikgPT4gRjcsXHJcbiAgZjg6IChiYXNlOiBGNykgPT4gRjgsXHJcbik6IFRCYXNlICYgRjEgJiBGMiAmIEYzICYgRjQgJiBGNSAmIEY2ICYgRjcgJiBGODtcclxuZXhwb3J0IGZ1bmN0aW9uIGNvbXBvc2VEb2M8VEJhc2UgZXh0ZW5kcyBHQ29uc3RydWN0b3IsIEYxLCBGMiwgRjMsIEY0LCBGNSwgRjYsIEY3LCBGOCwgRjk+KFxyXG4gIEJhc2U6IFRCYXNlLFxyXG4gIGYxOiAoYmFzZTogVEJhc2UpID0+IEYxLFxyXG4gIGYyOiAoYmFzZTogRjEpID0+IEYyLFxyXG4gIGYzOiAoYmFzZTogRjIpID0+IEYzLFxyXG4gIGY0OiAoYmFzZTogRjMpID0+IEY0LFxyXG4gIGY1OiAoYmFzZTogRjQpID0+IEY1LFxyXG4gIGY2OiAoYmFzZTogRjUpID0+IEY2LFxyXG4gIGY3OiAoYmFzZTogRjYpID0+IEY3LFxyXG4gIGY4OiAoYmFzZTogRjcpID0+IEY4LFxyXG4gIGY5OiAoYmFzZTogRjgpID0+IEY5LFxyXG4pOiBUQmFzZSAmIEYxICYgRjIgJiBGMyAmIEY0ICYgRjUgJiBGNiAmIEY3ICYgRjggJiBGOTtcclxuZXhwb3J0IGZ1bmN0aW9uIGNvbXBvc2VEb2M8VEJhc2UgZXh0ZW5kcyBHQ29uc3RydWN0b3I+KEJhc2U6IFRCYXNlLCAuLi5taXhpbnM6IGFueVtdKTogVEJhc2Uge1xyXG4gIHJldHVybiBtaXhpbnMucmVkdWNlKChhY2MsIG1peGluKSA9PiBtaXhpbihhY2MpLCBCYXNlKTtcclxufVxyXG4iXX0=