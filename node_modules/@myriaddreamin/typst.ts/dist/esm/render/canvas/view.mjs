import { TypstDefaultParams } from '../../internal.types.mjs';
/** @internal */
export class RenderView {
    pageInfos;
    loadPageCount;
    imageScaleFactor;
    container;
    canvasList;
    textLayerList;
    commonList;
    textLayerParentList;
    semanticLayerList;
    constructor(pageInfos, container, options) {
        this.pageInfos = pageInfos;
        this.imageScaleFactor = options.pixelPerPt ?? TypstDefaultParams.PIXEL_PER_PT;
        container.innerHTML = '';
        container.style.width = '100%';
        // canvas[data-typst-session='{}']
        /// refer html elements
        this.container = container;
        this.canvasList = new Array(this.loadPageCount);
        this.textLayerList = new Array(this.loadPageCount);
        this.commonList = new Array(this.loadPageCount);
        this.textLayerParentList = new Array(this.loadPageCount);
        this.semanticLayerList = new Array(this.loadPageCount);
        const createOver = (i, pageAst, commonDiv) => {
            const width = Math.ceil(pageAst.width) * this.imageScaleFactor;
            const height = Math.ceil(pageAst.height) * this.imageScaleFactor;
            const canvas = (this.canvasList[i] = document.createElement('canvas'));
            const semanticLayer = (this.semanticLayerList[i] = document.createElement('div'));
            const textLayer = (this.textLayerList[i] = document.createElement('div'));
            const textLayerParent = (this.textLayerParentList[i] = document.createElement('div'));
            const ctx = canvas.getContext('2d');
            if (ctx) {
                const canvasDiv = document.createElement('div');
                canvas.width = width;
                canvas.height = height;
                canvasDiv.appendChild(canvas);
                // canvasDiv.style.zIndex = '-1';
                // canvas.style.zIndex = '-1';
                commonDiv.appendChild(canvasDiv);
                canvasDiv.style.position = 'absolute';
            }
            {
                textLayerParent.appendChild(textLayer);
                textLayerParent.className = 'typst-html-semantics';
                /// on width change
                const containerWidth = container.offsetWidth;
                const originalScale = containerWidth / pageAst.width;
                textLayerParent.style.width = `${containerWidth}px`;
                textLayerParent.style.height = `${pageAst.height * originalScale}px`;
                // --data-text-width
                textLayerParent.style.setProperty('--data-text-width', `${originalScale}px`);
                textLayerParent.style.setProperty('--data-text-height', `${originalScale}px`);
                // textLayerParent.style.position = 'absolute';
                commonDiv.classList.add('typst-page');
                commonDiv.classList.add('canvas');
                commonDiv.style.width = `${containerWidth}px`;
                commonDiv.style.height = `${height * originalScale}px`;
                commonDiv.style.position = 'relative';
                // textLayerParent.style.zIndex = '1';
                semanticLayer.appendChild(textLayerParent);
                commonDiv.appendChild(semanticLayer);
            }
        };
        for (let i = 0; i < this.pageInfos.length; i++) {
            const pageAst = this.pageInfos[i];
            // const commonDiv = document.createElement('div');
            let commonDiv = undefined;
            commonDiv = this.commonList[i] = document.createElement('div');
            container.appendChild(commonDiv);
            createOver(i, pageAst, commonDiv);
        }
    }
    resetLayout() {
        /// resize again to avoid bad width change after render
        for (let i = 0; i < this.pageInfos.length; i++) {
            const pageAst = this.pageInfos[i];
            const width = Math.ceil(pageAst.width) * this.imageScaleFactor;
            const height = Math.ceil(pageAst.height) * this.imageScaleFactor;
            const canvasDiv = this.canvasList[i].parentElement;
            if (!canvasDiv) {
                throw new Error(`canvasDiv is null for page ${i}, canvas list length ${this.canvasList.length}`);
            }
            const commonDiv = this.commonList[i];
            const textLayerParent = this.textLayerParentList[i];
            /// on width change
            const containerWidth = this.container.offsetWidth;
            const originalScale = containerWidth / width;
            textLayerParent.style.width = `${containerWidth}px`;
            textLayerParent.style.height = `${height * originalScale}px`;
            commonDiv.style.width = `${containerWidth}px`;
            commonDiv.style.height = `${height * originalScale}px`;
            // compute scaling factor according to the paper size
            const currentScale = this.container.offsetWidth / width;
            canvasDiv.style.transformOrigin = '0px 0px';
            canvasDiv.style.transform = `scale(${currentScale})`;
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmlldy5tanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvcmVuZGVyL2NhbnZhcy92aWV3Lm10cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQVksa0JBQWtCLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUl4RSxnQkFBZ0I7QUFDaEIsTUFBTSxPQUFPLFVBQVU7SUFZWjtJQVhULGFBQWEsQ0FBUztJQUN0QixnQkFBZ0IsQ0FBUztJQUV6QixTQUFTLENBQWM7SUFDdkIsVUFBVSxDQUFzQjtJQUNoQyxhQUFhLENBQW1CO0lBQ2hDLFVBQVUsQ0FBbUI7SUFDN0IsbUJBQW1CLENBQW1CO0lBQ3RDLGlCQUFpQixDQUFtQjtJQUVwQyxZQUNTLFNBQXFCLEVBQzVCLFNBQXNCLEVBQ3RCLE9BQThCO1FBRnZCLGNBQVMsR0FBVCxTQUFTLENBQVk7UUFJNUIsSUFBSSxDQUFDLGdCQUFnQixHQUFHLE9BQU8sQ0FBQyxVQUFVLElBQUksa0JBQWtCLENBQUMsWUFBWSxDQUFDO1FBRTlFLFNBQVMsQ0FBQyxTQUFTLEdBQUcsRUFBRSxDQUFDO1FBQ3pCLFNBQVMsQ0FBQyxLQUFLLENBQUMsS0FBSyxHQUFHLE1BQU0sQ0FBQztRQUUvQixrQ0FBa0M7UUFFbEMsdUJBQXVCO1FBQ3ZCLElBQUksQ0FBQyxTQUFTLEdBQUcsU0FBUyxDQUFDO1FBQzNCLElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxLQUFLLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ2hELElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxLQUFLLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ25ELElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxLQUFLLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ2hELElBQUksQ0FBQyxtQkFBbUIsR0FBRyxJQUFJLEtBQUssQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUM7UUFDekQsSUFB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b3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBQYWdlSW5mbywgVHlwc3REZWZhdWx0UGFyYW1zIH0gZnJvbSAnLi4vLi4vaW50ZXJuYWwudHlwZXMubWpzJztcclxuaW1wb3J0IHsgUmVuZGVyVG9DYW52YXNPcHRpb25zIH0gZnJvbSAnLi4vLi4vb3B0aW9ucy5yZW5kZXIubWpzJztcclxuaW1wb3J0IHsgUGFnZVZpZXdwb3J0IH0gZnJvbSAnLi92aWV3cG9ydC5tanMnO1xyXG5cclxuLyoqIEBpbnRlcm5hbCAqL1xyXG5leHBvcnQgY2xhc3MgUmVuZGVyVmlldyB7XHJcbiAgbG9hZFBhZ2VDb3VudDogbnVtYmVyO1xyXG4gIGltYWdlU2NhbGVGYWN0b3I6IG51bWJlcjtcclxuXHJcbiAgY29udGFpbmVyOiBIVE1MRWxlbWVudDtcclxuICBjYW52YXNMaXN0OiBIVE1MQ2FudmFzRWxlbWVudFtdO1xyXG4gIHRleHRMYXllckxpc3Q6IEhUTUxEaXZFbGVtZW50W107XHJcbiAgY29tbW9uTGlzdDogSFRNTERpdkVsZW1lbnRbXTtcclxuICB0ZXh0TGF5ZXJQYXJlbnRMaXN0OiBIVE1MRGl2RWxlbWVudFtdO1xyXG4gIHNlbWFudGljTGF5ZXJMaXN0OiBIVE1MRGl2RWxlbWVudFtdO1xyXG5cclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHB1YmxpYyBwYWdlSW5mb3M6IFBhZ2VJbmZvW10sXHJcbiAgICBjb250YWluZXI6IEhUTUxFbGVtZW50LFxyXG4gICAgb3B0aW9uczogUmVuZGVyVG9DYW52YXNPcHRpb25zLFxyXG4gICkge1xyXG4gICAgdGhpcy5pbWFnZVNjYWxlRmFjdG9yID0gb3B0aW9ucy5waXhlbFBlclB0ID8/IFR5cHN0RGVmYXVsdFBhcmFtcy5QSVhFTF9QRVJfUFQ7XHJcblxyXG4gICAgY29udGFpbmVyLmlubmVySFRNTCA9ICcnO1xyXG4gICAgY29udGFpbmVyLnN0eWxlLndpZHRoID0gJzEwMCUnO1xyXG5cclxuICAgIC8vIGNhbnZhc1tkYXRhLXR5cHN0LXNlc3Npb249J3t9J11cclxuXHJcbiAgICAvLy8gcmVmZXIgaHRtbCBlbGVtZW50c1xyXG4gICAgdGhpcy5jb250YWluZXIgPSBjb250YWluZXI7XHJcbiAgICB0aGlzLmNhbnZhc0xpc3QgPSBuZXcgQXJyYXkodGhpcy5sb2FkUGFnZUNvdW50KTtcclxuICAgIHRoaXMudGV4dExheWVyTGlzdCA9IG5ldyBBcnJheSh0aGlzLmxvYWRQYWdlQ291bnQpO1xyXG4gICAgdGhpcy5jb21tb25MaXN0ID0gbmV3IEFycmF5KHRoaXMubG9hZFBhZ2VDb3VudCk7XHJcbiAgICB0aGlzLnRleHRMYXllclBhcmVudExpc3QgPSBuZXcgQXJyYXkodGhpcy5sb2FkUGFnZUNvdW50KTtcclxuICAgIHRoaXMuc2VtYW50aWNMYXllckxpc3QgPSBuZXcgQXJyYXkodGhpcy5sb2FkUGFnZUNvdW50KTtcclxuXHJcbiAgICBjb25zdCBjcmVhdGVPdmVyID0gKGk6IG51bWJlciwgcGFnZUFzdDogUGFnZUluZm8sIGNvbW1vbkRpdjogSFRNTERpdkVsZW1lbnQpID0+IHtcclxuICAgICAgY29uc3Qgd2lkdGggPSBNYXRoLmNlaWwocGFnZUFzdC53aWR0aCkgKiB0aGlzLmltYWdlU2NhbGVGYWN0b3I7XHJcbiAgICAgIGNvbnN0IGhlaWdodCA9IE1hdGguY2VpbChwYWdlQXN0LmhlaWdodCkgKiB0aGlzLmltYWdlU2NhbGVGYWN0b3I7XHJcblxyXG4gICAgICBjb25zdCBjYW52YXMgPSAodGhpcy5jYW52YXNMaXN0W2ldID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJykpO1xyXG4gICAgICBjb25zdCBzZW1hbnRpY0xheWVyID0gKHRoaXMuc2VtYW50aWNMYXllckxpc3RbaV0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKSk7XHJcbiAgICAgIGNvbnN0IHRleHRMYXllciA9ICh0aGlzLnRleHRMYXllckxpc3RbaV0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKSk7XHJcbiAgICAgIGNvbnN0IHRleHRMYXllclBhcmVudCA9ICh0aGlzLnRleHRMYXllclBhcmVudExpc3RbaV0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKSk7XHJcblxyXG4gICAgICBjb25zdCBjdHggPSBjYW52YXMuZ2V0Q29udGV4dCgnMmQnKTtcclxuICAgICAgaWYgKGN0eCkge1xyXG4gICAgICAgIGNvbnN0IGNhbnZhc0RpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xyXG5cclxuICAgICAgICBjYW52YXMud2lkdGggPSB3aWR0aDtcclxuICAgICAgICBjYW52YXMuaGVpZ2h0ID0gaGVpZ2h0O1xyXG5cclxuICAgICAgICBjYW52YXNEaXYuYXBwZW5kQ2hpbGQoY2FudmFzKTtcclxuICAgICAgICAvLyBjYW52YXNEaXYuc3R5bGUuekluZGV4ID0gJy0xJztcclxuICAgICAgICAvLyBjYW52YXMuc3R5bGUuekluZGV4ID0gJy0xJztcclxuICAgICAgICBjb21tb25EaXYuYXBwZW5kQ2hpbGQoY2FudmFzRGl2KTtcclxuICAgICAgICBjYW52YXNEaXYuc3R5bGUucG9zaXRpb24gPSAnYWJzb2x1dGUnO1xyXG4gICAgICB9XHJcblxyXG4gICAgICB7XHJcbiAgICAgICAgdGV4dExheWVyUGFyZW50LmFwcGVuZENoaWxkKHRleHRMYXllcik7XHJcblxyXG4gICAgICAgIHRleHRMYXllclBhcmVudC5jbGFzc05hbWUgPSAndHlwc3QtaHRtbC1zZW1hbnRpY3MnO1xyXG5cclxuICAgICAgICAvLy8gb24gd2lkdGggY2hhbmdlXHJcbiAgICAgICAgY29uc3QgY29udGFpbmVyV2lkdGggPSBjb250YWluZXIub2Zmc2V0V2lkdGg7XHJcbiAgICAgICAgY29uc3Qgb3JpZ2luYWxTY2FsZSA9IGNvbnRhaW5lcldpZHRoIC8gcGFnZUFzdC53aWR0aDtcclxuICAgICAgICB0ZXh0TGF5ZXJQYXJlbnQuc3R5bGUud2lkdGggPSBgJHtjb250YWluZXJXaWR0aH1weGA7XHJcbiAgICAgICAgdGV4dExheWVyUGFyZW50LnN0eWxlLmhlaWdodCA9IGAke3BhZ2VBc3QuaGVpZ2h0ICogb3JpZ2luYWxTY2FsZX1weGA7XHJcbiAgICAgICAgLy8gLS1kYXRhLXRleHQtd2lkdGhcclxuICAgICAgICB0ZXh0TGF5ZXJQYXJlbnQuc3R5bGUuc2V0UHJvcGVydHkoJy0tZGF0YS10ZXh0LXdpZHRoJywgYCR7b3JpZ2luYWxTY2FsZX1weGApO1xyXG4gICAgICAgIHRleHRMYXllclBhcmVudC5zdHlsZS5zZXRQcm9wZXJ0eSgnLS1kYXRhLXRleHQtaGVpZ2h0JywgYCR7b3JpZ2luYWxTY2FsZX1weGApO1xyXG4gICAgICAgIC8vIHRleHRMYXllclBhcmVudC5zdHlsZS5wb3NpdGlvbiA9ICdhYnNvbHV0ZSc7XHJcbiAgICAgICAgY29tbW9uRGl2LmNsYXNzTGlzdC5hZGQoJ3R5cHN0LXBhZ2UnKTtcclxuICAgICAgICBjb21tb25EaXYuY2xhc3NMaXN0LmFkZCgnY2FudmFzJyk7XHJcbiAgICAgICAgY29tbW9uRGl2LnN0eWxlLndpZHRoID0gYCR7Y29udGFpbmVyV2lkdGh9cHhgO1xyXG4gICAgICAgIGNvbW1vbkRpdi5zdHlsZS5oZWlnaHQgPSBgJHtoZWlnaHQgKiBvcmlnaW5hbFNjYWxlfXB4YDtcclxuICAgICAgICBjb21tb25EaXYuc3R5bGUucG9zaXRpb24gPSAncmVsYXRpdmUnO1xyXG5cclxuICAgICAgICAvLyB0ZXh0TGF5ZXJQYXJlbnQuc3R5bGUuekluZGV4ID0gJzEnO1xyXG4gICAgICAgIHNlbWFudGljTGF5ZXIuYXBwZW5kQ2hpbGQodGV4dExheWVyUGFyZW50KTtcclxuICAgICAgICBjb21tb25EaXYuYXBwZW5kQ2hpbGQoc2VtYW50aWNMYXllcik7XHJcbiAgICAgIH1cclxuICAgIH07XHJcblxyXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnBhZ2VJbmZvcy5sZW5ndGg7IGkrKykge1xyXG4gICAgICBjb25zdCBwYWdlQXN0ID0gdGhpcy5wYWdlSW5mb3NbaV07XHJcblxyXG4gICAgICAvLyBjb25zdCBjb21tb25EaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcclxuICAgICAgbGV0IGNvbW1vbkRpdjogSFRNTERpdkVsZW1lbnQgfCB1bmRlZmluZWQgPSB1bmRlZmluZWQ7XHJcblxyXG4gICAgICBjb21tb25EaXYgPSB0aGlzLmNvbW1vbkxpc3RbaV0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcclxuICAgICAgY29udGFpbmVyLmFwcGVuZENoaWxkKGNvbW1vbkRpdik7XHJcbiAgICAgIGNyZWF0ZU92ZXIoaSwgcGFnZUFzdCwgY29tbW9uRGl2KTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHJlc2V0TGF5b3V0KCkge1xyXG4gICAgLy8vIHJlc2l6ZSBhZ2FpbiB0byBhdm9pZCBiYWQgd2lkdGggY2hhbmdlIGFmdGVyIHJlbmRlclxyXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnBhZ2VJbmZvcy5sZW5ndGg7IGkrKykge1xyXG4gICAgICBjb25zdCBwYWdlQXN0ID0gdGhpcy5wYWdlSW5mb3NbaV07XHJcbiAgICAgIGNvbnN0IHdpZHRoID0gTWF0aC5jZWlsKHBhZ2VBc3Qud2lkdGgpICogdGhpcy5pbWFnZVNjYWxlRmFjdG9yO1xyXG4gICAgICBjb25zdCBoZWlnaHQgPSBNYXRoLmNlaWwocGFnZUFzdC5oZWlnaHQpICogdGhpcy5pbWFnZVNjYWxlRmFjdG9yO1xyXG5cclxuICAgICAgY29uc3QgY2FudmFzRGl2ID0gdGhpcy5jYW52YXNMaXN0W2ldLnBhcmVudEVsZW1lbnQ7XHJcbiAgICAgIGlmICghY2FudmFzRGl2KSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxyXG4gICAgICAgICAgYGNhbnZhc0RpdiBpcyBudWxsIGZvciBwYWdlICR7aX0sIGNhbnZhcyBsaXN0IGxlbmd0aCAke3RoaXMuY2FudmFzTGlzdC5sZW5ndGh9YCxcclxuICAgICAgICApO1xyXG4gICAgICB9XHJcbiAgICAgIGNvbnN0IGNvbW1vbkRpdiA9IHRoaXMuY29tbW9uTGlzdFtpXTtcclxuICAgICAgY29uc3QgdGV4dExheWVyUGFyZW50ID0gdGhpcy50ZXh0TGF5ZXJQYXJlbnRMaXN0W2ldO1xyXG5cclxuICAgICAgLy8vIG9uIHdpZHRoIGNoYW5nZVxyXG4gICAgICBjb25zdCBjb250YWluZXJXaWR0aCA9IHRoaXMuY29udGFpbmVyLm9mZnNldFdpZHRoO1xyXG4gICAgICBjb25zdCBvcmlnaW5hbFNjYWxlID0gY29udGFpbmVyV2lkdGggLyB3aWR0aDtcclxuICAgICAgdGV4dExheWVyUGFyZW50LnN0eWxlLndpZHRoID0gYCR7Y29udGFpbmVyV2lkdGh9cHhgO1xyXG4gICAgICB0ZXh0TGF5ZXJQYXJlbnQuc3R5bGUuaGVpZ2h0ID0gYCR7aGVpZ2h0ICogb3JpZ2luYWxTY2FsZX1weGA7XHJcbiAgICAgIGNvbW1vbkRpdi5zdHlsZS53aWR0aCA9IGAke2NvbnRhaW5lcldpZHRofXB4YDtcclxuICAgICAgY29tbW9uRGl2LnN0eWxlLmhlaWdodCA9IGAke2hlaWdodCAqIG9yaWdpbmFsU2NhbGV9cHhgO1xyXG5cclxuICAgICAgLy8gY29tcHV0ZSBzY2FsaW5nIGZhY3RvciBhY2NvcmRpbmcgdG8gdGhlIHBhcGVyIHNpemVcclxuICAgICAgY29uc3QgY3VycmVudFNjYWxlID0gdGhpcy5jb250YWluZXIub2Zmc2V0V2lkdGggLyB3aWR0aDtcclxuICAgICAgY2FudmFzRGl2LnN0eWxlLnRyYW5zZm9ybU9yaWdpbiA9ICcwcHggMHB4JztcclxuICAgICAgY2FudmFzRGl2LnN0eWxlLnRyYW5zZm9ybSA9IGBzY2FsZSgke2N1cnJlbnRTY2FsZX0pYDtcclxuICAgIH1cclxuICB9XHJcbn1cclxuIl19